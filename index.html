<!doctype html>
<html lang="ja">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>„Åµ„Å§„ÅÜ„ÅÆÊîæÁΩÆ„Ç≤„Éº„É†ÔºàZÔºâ</title>
    <style>
        :root {
            --bg: #0f1724;
            --panel: #0b1220;
            --accent: #7dd3fc;
            --muted: #94a3b8;
            --card: #0e1a2b;
            --glass: rgba(255, 255, 255, 0.03);
            --glass-2: rgba(255, 255, 255, 0.02);
            --radius: 12px;
            font-family: "Noto Sans JP", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
        }

        html,
        body {
            height: 100%;
            margin: 0;
            background: linear-gradient(180deg, #071029 0%, #061727 100%);
            color: #e6eef6
        }

        .container {
            display: grid;
            grid-template-columns: 1fr 2fr 320px;
            gap: 16px;
            height: 100vh;
            padding: 18px;
            box-sizing: border-box;
        }

        /* Left column */
        .left {
            background: linear-gradient(180deg, var(--panel), #061424);
            border-radius: var(--radius);
            padding: 16px;
            box-shadow: 0 6px 18px rgba(2, 6, 23, 0.6);
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .left-top {
            background: var(--glass);
            padding: 14px;
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
        }

        .money {
            display: flex;
            flex-direction: column;
        }

        .money .label {
            font-size: 13px;
            color: var(--muted)
        }

        .money .value {
            font-size: 22px;
            font-weight: 700;
            color: #fff;
            letter-spacing: 0.02em;
        }

        .zps {
            text-align: right;
        }

        .zps .label {
            font-size: 13px;
            color: var(--muted)
        }

        .zps .value {
            font-size: 18px;
            font-weight: 600;
            color: var(--accent)
        }

        .left-middle {
            flex: 1;
            background: var(--glass-2);
            border-radius: 10px;
            padding: 12px;
            overflow: auto;
        }

        /* Center column */
        .center {
            background: linear-gradient(180deg, #07182a, #051223);
            border-radius: var(--radius);
            padding: 18px;
            display: flex;
            flex-direction: column;
            gap: 16px;
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.6);
        }

        .big-action {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 14px;
            flex-wrap: wrap;
        }

        .big-click {
            background: linear-gradient(180deg, #0ea5a0, #046b6b);
            border-radius: 18px;
            padding: 22px 28px;
            font-size: 20px;
            font-weight: 700;
            cursor: pointer;
            user-select: none;
            box-shadow: 0 8px 30px rgba(4, 139, 139, 0.18), inset 0 -4px 12px rgba(255, 255, 255, 0.03);
        }

        .mini-info {
            background: var(--glass);
            padding: 12px 16px;
            border-radius: 12px;
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .center-bottom {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
        }

        .card {
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.02), rgba(255, 255, 255, 0.01));
            padding: 12px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.03);
        }

        /* Artifact Tree */
        .artifact-panel {
            background: var(--card);
            border-radius: 12px;
            padding: 16px;
            position: relative;
            min-height: 500px;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .artifact-tree-svg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
        }

        .artifact-node {
            position: absolute;
            transform: translate(-50%, -50%);
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: linear-gradient(180deg, #1f2937, #111827);
            border: 2px solid #374151;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 20px;
            cursor: pointer;
            z-index: 1;
            transition: all 0.2s;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .artifact-node:hover {
            transform: translate(-50%, -50%) scale(1.1);
            border-color: var(--accent);
            z-index: 10;
        }

        .artifact-node.bought {
            background: linear-gradient(180deg, #0ea5e9, #0284c7);
            border-color: #7dd3fc;
            box-shadow: 0 0 15px rgba(14, 165, 233, 0.4);
        }

        .artifact-node.locked {
            opacity: 0.5;
            cursor: not-allowed;
            filter: grayscale(1);
        }

        .artifact-node.available {
            border-color: #fbbf24;
            animation: pulse-border 2s infinite;
        }

        @keyframes pulse-border {
            0% {
                box-shadow: 0 0 0 0 rgba(251, 191, 36, 0.4);
            }

            70% {
                box-shadow: 0 0 0 6px rgba(251, 191, 36, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(251, 191, 36, 0);
            }
        }

        .artifact-tooltip {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 12px;
            pointer-events: none;
            white-space: nowrap;
            z-index: 20;
            border: 1px solid rgba(255, 255, 255, 0.1);
            display: none;
        }

        /* Right column (tabbed area) */
        .right {
            background: linear-gradient(180deg, #071826, #04121a);
            border-radius: var(--radius);
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            box-shadow: 0 8px 22px rgba(2, 6, 23, 0.6);
        }

        .tabs {
            display: flex;
            gap: 10px;
        }

        .tab-btn {
            flex: 1;
            padding: 10px 12px;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            user-select: none;
            background: transparent;
            color: var(--muted);
            border: 1px solid transparent;
            font-weight: 700;
        }

        .tab-btn.active {
            background: linear-gradient(180deg, rgba(125, 211, 252, 0.12), rgba(125, 211, 252, 0.06));
            color: var(--accent);
            border: 1px solid rgba(125, 211, 252, 0.12);
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.45);
        }

        .tab-content {
            background: var(--card);
            border-radius: 10px;
            padding: 12px;
            flex: 1;
            overflow: auto;
        }

        /* Producer list */
        .producer {
            display: flex;
            justify-content: space-between;
            gap: 10px;
            align-items: center;
            padding: 8px;
            border-radius: 8px;
            margin-bottom: 8px;
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.01), rgba(255, 255, 255, 0.00));
            border: 1px solid rgba(255, 255, 255, 0.02);
        }

        .producer .left {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .producer .name {
            font-weight: 700
        }

        .producer .meta {
            font-size: 12px;
            color: var(--muted)
        }

        .buy-btn {
            padding: 8px 10px;
            border-radius: 8px;
            cursor: pointer;
            background: linear-gradient(180deg, #1f2937, #0f1724);
            color: #e6eef6;
            border: 1px solid rgba(255, 255, 255, 0.03);
            font-weight: 700;
        }

        .buy-btn:disabled {
            opacity: 0.45;
            cursor: not-allowed
        }

        /* Upgrades */
        .upgrade {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            padding: 8px;
            border-radius: 8px;
            margin-bottom: 8px;
            border: 1px solid rgba(255, 255, 255, 0.02);
        }

        /* Achievements */
        .ach {
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 8px;
            background: rgba(255, 255, 255, 0.01);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }

        .ach.locked {
            opacity: 0.5
        }

        /* footer small */
        .small {
            font-size: 12px;
            color: var(--muted);
            text-align: center;
            padding: 6px;
        }

        /* responsive */
        @media(max-width:900px) {
            .container {
                grid-template-columns: 1fr;
                grid-auto-rows: min-content;
                padding: 12px;
                gap: 12px;
            }

            .right {
                order: 3
            }

            .left {
                order: 1
            }

            .center {
                order: 2
            }
        }



        /* Toggle Switch */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 36px;
            height: 20px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #334155;
            transition: .4s;
            border-radius: 20px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked+.slider {
            background-color: var(--accent);
        }

        input:checked+.slider:before {
            transform: translateX(16px);
        }

        /* Tree Tabs */
        .tree-tabs {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-bottom: 12px;
        }

        .tree-tab {
            padding: 4px 12px;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--muted);
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .tree-tab:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
        }

        .tree-tab.active {
            background: var(--accent);
            color: #000;
            border-color: var(--accent);
            font-weight: 700;
        }
    </style>
</head>

<body>
    <div class="container"><!-- LEFT -->
        <div class="left" id="leftPanel">
            <div class="left-top">
                <div class="money">
                    <div class="label">ÊâÄÊåÅZ</div>
                    <div class="value" id="money">0</div>
                </div>
                <div class="zps">
                    <div class="label">1Áßí„ÅÇ„Åü„Çä„ÅÆÁîüÁî£</div>
                    <div class="value" id="zps">0 Z/s</div>
                </div>
            </div>
            <div class="left-middle" id="leftMiddle">
                <h3 style="margin:6px 0 10px 0">Áµ±Ë®à / „Çª„Éº„Éñ</h3>
                <div class="card" style="margin-bottom:8px">
                    <div>Á∑èÁç≤ÂæóZ: <span id="totalZ">0</span></div>
                    <div>„Éó„É¨„Ç§ÊôÇÈñì: <span id="playTime">0s</span></div>
                    <div style="margin-top:4px; border-top:1px solid rgba(255,255,255,0.1); padding-top:4px">
                        <div style="font-size:12px;color:var(--muted)">Ëª¢ÁîüÂõûÊï∞: <span id="reincarnationCount">0</span>
                        </div>
                        <div style="font-size:12px;color:var(--muted)">Ëª¢Áîü„Éú„Éº„Éä„Çπ: <span id="prestigeMult">x1.00</span>
                        </div>
                        <div style="font-size:12px;color:var(--muted)">Ëª¢Áîü„Éù„Ç§„É≥„Éà: <span id="rpValue">0</span>
                        </div>
                    </div>
                </div>
                <div class="card"><button id="emergencyStopBtn" class="buy-btn"
                        style="width:100%;margin-bottom:8px;border:1px solid #f59e0b;color:#f59e0b;background:transparent">Á∑äÊÄ•ÂÅúÊ≠¢
                        (Ëá™ÂãïÂåñOFF)</button><button id="saveBtn" class="buy-btn"
                        style="width:100%;margin-bottom:8px">„Çª„Éº„Éñ</button><button id="loadBtn" class="buy-btn"
                        style="width:100%;margin-bottom:8px">„É≠„Éº„Éâ</button><button id="resetBtn" class="buy-btn"
                        style="width:100%;background:#7f1d1d;border-color:#7f1d1d">„É™„Çª„ÉÉ„Éà</button></div>
                <div class="card" id="automationPanel" style="display:none; margin-top:8px">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px">
                        <div style="font-size:13px; color:var(--accent)">Ëá™ÂãïË≥ºÂÖ• (Ë®≠ÂÇô)</div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="autoBuyToggle" checked>
                            <span class="slider"></span>
                        </label>
                    </div>
                    <!-- Auto Upgrade -->
                    <div id="autoUpgradeRow"
                        style="display:none; justify-content:space-between; align-items:center; margin-bottom:8px">
                        <div style="font-size:13px; color:var(--accent)">Ëá™ÂãïË≥ºÂÖ• (Áü•ÊÅµ)</div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="autoUpgradeToggle">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <!-- Auto Reincarnate -->
                    <div id="autoReincarnateRow" style="display:none; flex-direction:column; gap:6px">
                        <div style="display:flex; justify-content:space-between; align-items:center">
                            <div style="font-size:13px; color:#f59e0b">Ëá™ÂãïËª¢Áîü</div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="autoReincarnateToggle">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div style="display:flex; gap:8px; align-items:center">
                            <div style="font-size:12px; color:var(--muted)">ÈñæÂÄ§Z (Min: 1e20):</div>
                            <input type="number" id="autoReincarnateInput"
                                style="width:100%; background:rgba(0,0,0,0.3); border:1px solid rgba(255,255,255,0.1); color:#fff; border-radius:4px; padding:4px;"
                                placeholder="‰æã: 1e20">
                        </div>
                    </div>
                    <!-- Auto Manipulator -->
                    <div id="autoManipulatorRow"
                        style="display:none; flex-direction:column; gap:6px; margin-top:8px; border-top:1px solid rgba(255,255,255,0.1); padding-top:8px">
                        <div style="display:flex; justify-content:space-between; align-items:center">
                            <div style="font-size:13px; color:#d8b4fe">„Éû„Éã„Éî„É•„É¨„Éº„Çø</div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="autoManipulatorToggle">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div style="display:flex; gap:8px; align-items:center">
                            <select id="autoManipulatorSelect"
                                style="flex:1; background:rgba(0,0,0,0.3); border:1px solid rgba(255,255,255,0.1); color:#fff; border-radius:4px; padding:4px;">
                                <option value="">(ÂÅúÊ≠¢‰∏≠)</option>
                            </select>
                        </div>
                        <div style="display:flex; gap:8px; align-items:center">
                            <div style="font-size:12px; color:var(--muted)">ÁõÆÊ®ôÊï∞:</div>
                            <input type="number" id="autoManipulatorCap"
                                style="width:100%; background:rgba(0,0,0,0.3); border:1px solid rgba(255,255,255,0.1); color:#fff; border-radius:4px; padding:4px;"
                                placeholder="‰æã: 100">
                        </div>
                    </div>
                </div>
            </div>
        </div><!-- CENTER -->
        <div class="center">
            <div class="big-action">
                <div class="big-click" id="tapGain">„ÇØ„É™„ÉÉ„ÇØ„ÅßZ„ÇíÂæó„Çã</div>
                <div class="mini-info card">
                    <div>
                        <div style="font-size:12px; color:var(--muted)">„ÇØ„É™„ÉÉ„ÇØ„ÅßÂæó„Çâ„Çå„ÇãZ</div>
                        <div style="font-weight:700; font-size:16px" id="clickValue">1</div>
                    </div>
                    <div style="margin-left:auto;text-align:right">
                        <div style="font-size:12px;color:var(--muted)">Ê¨°„ÅÆÊùë‰∫∫‰æ°Ê†º</div>
                        <div style="font-weight:700" id="nextVillagerCost">--</div>
                    </div>
                </div>
            </div><!-- Artifact Tree Section -->
            <div class="artifact-panel" id="artifactPanel">
                <div class="tree-tabs">
                    <div class="tree-tab active" data-tree="1">Âü∫Êú¨</div>
                    <div class="tree-tab" data-tree="2">Áô∫Â±ï</div>
                    <div class="tree-tab" data-tree="3">ÊåëÊà¶</div>
                </div>
                <svg class="artifact-tree-svg" id="treeSvg"></svg>
                <div id="treeNodes"></div>
                <div class="artifact-tooltip" id="artifactTooltip"></div>
            </div>
        </div><!-- RIGHT -->
        <div class="right">
            <div class="tabs">
                <div class="tab-btn active" data-tab="mono" id="tabMono">„É¢„Éé</div>
                <div class="tab-btn" data-tab="chie" id="tabChie">Áü•ÊÅµ</div>
                <div class="tab-btn" data-tab="ach" id="tabAch">ÂÆüÁ∏æ</div>
            </div>
            <div class="tab-content" id="tabContent"><!-- default: „É¢„Éé -->
                <div id="monoPanel"></div>
            </div>
            <div style="display:flex;gap:8px;align-items:center">
                <div style="flex:1" class="small">„Éê„Éº„Ç∏„Éß„É≥: 1.13 ¬∑ ‰øùÂ≠ò„ÅØ„Éñ„É©„Ç¶„Ç∂„Å´‰øùÊåÅ</div>
                <div class="small" style="color:#ef4444;cursor:pointer;text-decoration:underline" id="deleteDataBtn">
                    „Éá„Éº„ÇøÂâäÈô§</div>
            </div>
        </div>
    </div>
    <script>
        /*
                  Êó•Êú¨Ë™û„Ç≥„É°„É≥„Éà‰ªò„Åç JavaScriptÔºà‰øÆÊ≠£Áâà„ÉªÂÆåÂÖ®ÁâàÔºâ
                  ‚Äª Ê©üËÉΩ„ÅØÂÖÉ„ÅÆ„Åæ„Åæ„ÄÅ„Éê„Ç∞‰øÆÊ≠£„Å®ÊúÄÂ∞è„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ„ÅÆ„Åø„ÇíËøΩÂä†„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇ
                */

        /* ----- ÂÆöÊï∞„Å®ÂàùÊúü„Éá„Éº„Çø ----- */
        const GAME_SAVE_KEY = "idle_z_save_v1";

        const defaultProducers = [{
            id: 'villager', name: 'Êùë‰∫∫', baseCost: 10, costMult: 1.15, baseProd: 0.5, count: 0, icon: 'üë®‚Äçüåæ'
        }

            ,
        {
            id: 'farmer', name: 'Ëæ≤Â§´', baseCost: 120, costMult: 1.15, baseProd: 6, count: 0, icon: 'üåæ'
        }

            ,
        {
            id: 'miner', name: 'Êé°ÊéòËÄÖ', baseCost: 1500, costMult: 1.15, baseProd: 80, count: 0, icon: '‚õèÔ∏è'
        }

            ,
        {
            id: 'factory', name: 'Â∑•Â†¥', baseCost: 20000, costMult: 1.17, baseProd: 1200, count: 0, icon: 'üè≠'
        },
        {
            id: 'coal_mine', name: 'ÁÇ≠Èâ±', baseCost: 400000, costMult: 1.18, baseProd: 8000, count: 0, icon: '‚öíÔ∏è'
        },
        {
            id: 'steam_engine', name: 'Ëí∏Ê∞óÊ©üÈñ¢', baseCost: 10000000, costMult: 1.20, baseProd: 150000, count: 0, icon: 'üöÇ'
        },
        {
            id: 'oil_field', name: 'Ê≤πÁî∞', baseCost: 500000000, costMult: 1.22, baseProd: 5000000, count: 0, icon: 'üõ¢Ô∏è'
        }

        ];

        const defaultUpgrades = [{

            id: 'clickBoost',
            name: '„ÇØ„É™„ÉÉ„ÇØÂäπÁéá *2',
            desc: '„ÇØ„É™„ÉÉ„ÇØ„ÅßÂæó„ÇãZ„ÅåÂ¢ó„Åà„Çã',
            cost: 50,
            bought: false,
            apply: (g) => {
                g.clickPower *= 2
            }
        }

            ,
        {

            id: 'prodBoost1',
            name: 'ÁîüÁî£ÂäπÁéá +25%',
            desc: 'ÂÖ®„É¶„Éã„ÉÉ„Éà„ÅÆÁîüÁî£„Åå+25%',
            cost: 1000,
            bought: false,
            apply: (g) => {
                g.globalMultiplier *= 1.25
            }
        }

            ,
        {

            id: 'prodBoost2',
            name: 'ÁîüÁî£ÂäπÁéá +100%',
            desc: 'ÂÖ®„É¶„Éã„ÉÉ„Éà„ÅÆÁîüÁî£„Åå+100%',
            cost: 20000,
            bought: false,
            apply: (g) => {
                g.globalMultiplier *= 2
            }
        }

            ,
        {

            id: 'intensiveFarming',
            name: 'ÈõÜÁ¥ÑÁöÑËæ≤Ê•≠',
            desc: 'Êùë‰∫∫„Å®Ëæ≤Â§´„ÅÆÁîüÁî£„Åå+500%',
            cost: 5000,
            bought: false,
            apply: (g) => {
                if (!g.producerMultipliers) g.producerMultipliers = {}

                    ;
                g.producerMultipliers['villager'] = (g.producerMultipliers['villager'] || 1) * 6;
                g.producerMultipliers['farmer'] = (g.producerMultipliers['farmer'] || 1) * 6;
            }
        },

        {

            id: 'clickserious',
            name: '„ÇØ„É™„ÉÉ„ÇØ„Å†„Å£„Å¶Êú¨Ê∞ó„Åß„Åô',
            desc: '„ÇØ„É™„ÉÉ„ÇØ„Åå„Åô„Å£„Åî„ÅÑ„Åµ„Åà„Çã',
            cost: 500000000,
            bought: false,
            apply: (g) => {
                g.clickPower *= 1000000000000000
            }
        }

        ];

        const defaultArtifacts = [{
            id: 'art_tablet',
            name: 'Âè§‰ª£„ÅÆÁü≥Êùø',
            desc: 'ÁîüÁî£ÂäπÁéá +10000%',
            cost: 1,
            currency: 'RP',
            x: 50,
            y: 15,
            parent: null,
            icon: 'üìú',
            treeId: 1,
            apply: (g) => {
                g.globalMultiplier *= 101;
            }
        },
        {
            id: 'art_stone',
            name: 'Áü≥„ÅÆÈÅìÂÖ∑',
            desc: '„ÇØ„É™„ÉÉ„ÇØ +500',
            cost: 1,
            currency: 'RP',
            x: 35,
            y: 30,
            parent: 'art_tablet',
            icon: 'ü™®',
            treeId: 1,
            apply: (g) => {
                g.clickPower += 500;
            }
        },
        {
            id: 'art_irrig',
            name: 'ÁÅåÊºë',
            desc: 'Ëæ≤Â§´„ÅÆÁîüÁî£ +5000%',
            cost: 1,
            currency: 'RP',
            x: 55,
            y: 50,
            parent: 'art_coop',
            icon: 'üíß',
            treeId: 1,
            apply: (g) => {
                if (!g.producerMultipliers) g.producerMultipliers = {};
                g.producerMultipliers['farmer'] = (g.producerMultipliers['farmer'] || 1) * 51;
            }
        },
        {
            id: 'art_iron',
            name: 'ÈâÑ„ÅÆÈÅìÂÖ∑',
            desc: '„ÇØ„É™„ÉÉ„ÇØ +1000',
            cost: 1,
            currency: 'RP',
            x: 25,
            y: 50,
            parent: 'art_stone',
            icon: '‚öîÔ∏è',
            treeId: 1,
            apply: (g) => {
                g.clickPower += 1000;
            }
        },
        {
            id: 'art_coop',
            name: 'Ëæ≤Ê•≠ÂçîÂêåÁµÑÂêà',
            desc: 'Êùë‰∫∫„ÅÆ„Ç≥„Çπ„Éà„Åå„ÇÅ„Å£„Å°„ÇÉÊ∏õ„Çã„Å´„Å™„Çã',
            cost: 1,
            currency: 'RP',
            x: 65,
            y: 30,
            parent: 'art_tablet',
            icon: 'ü§ù',
            treeId: 1,
            apply: (g) => {
                const v = producers.find(p => p.id === 'villager');
                if (v) v.baseCost = v.baseCost * 0.0000000000001;
            }
        },
        {
            id: 'cropmajor',
            name: 'Á©ÄÁâ©„É°„Ç∏„É£„Éº',
            desc: 'Êùë‰∫∫„ÅÆ„Ç≥„Çπ„Éà„Åå„ÇÅ„Å£„Å°„ÇÉÊ∏õ„Çã',
            cost: 1,
            currency: 'RP',
            x: 85,
            y: 40,
            parent: 'art_coop',
            icon: 'ü§ù',
            treeId: 1,
            apply: (g) => {
                const v = producers.find(p => p.id === 'villager');
                if (v) v.baseCost = v.baseCost * 0.00000000000001;
            }
        },
        {
            id: 'populationinfration',
            name: '‰∫∫Âè£ÁàÜÁô∫',
            desc: 'Êùë‰∫∫„ÅÆ„Ç≥„Çπ„Éà„Åå„ÇÅ„Å£„Å°„ÇÉÊ∏õ„Çã',
            cost: 1,
            currency: 'RP',
            x: 90,
            y: 60,
            parent: 'cropmajor',
            icon: 'ü§ù',
            treeId: 1,
            apply: (g) => {
                const v = producers.find(p => p.id === 'villager');
                if (v) v.baseCost = v.baseCost * 0.000000000000000001;
            }
        },
        {
            id: 'art_crop',
            name: 'Ëº™‰Ωú',
            desc: 'Ëæ≤Â§´„ÅÆÁîüÁî£ +10000%',
            cost: 1,
            currency: 'RP',
            x: 55,
            y: 70,
            parent: 'art_irrig',
            icon: 'üîÑ',
            treeId: 1,
            apply: (g) => {
                if (!g.producerMultipliers) g.producerMultipliers = {};
                g.producerMultipliers['farmer'] = (g.producerMultipliers['farmer'] || 1) * 101;
            }
        },
        {
            id: 'art_manager',
            name: 'Ëá™ÂãïÂåñ„ÅÆÊ≠ØËªä',
            desc: 'ÊúÄ„ÇÇÁîüÁî£„ÅåÈ´ò„ÅÑË®≠ÂÇô„ÇíËá™Âãï„ÅßË≥ºÂÖ• / On/OffÂèØËÉΩ',
            cost: 5,
            currency: 'RP',
            x: 25,
            y: 75,
            parent: 'art_iron',
            icon: '‚öôÔ∏è',
            treeId: 1,
            apply: (g) => {
                g.autoBuy = true;
            }
        },
        {
            id: 'haguruma',
            name: 'Ê≠ØËªä',
            desc: 'Â∑•Â†¥„ÅÆÁîüÁî£„Åå1000ÂÄç',
            cost: 1,
            currency: 'RP',
            x: 25,
            y: 95,
            parent: 'art_manager',
            icon: '‚öôÔ∏è',
            treeId: 1,
            apply: (g) => {
                if (!g.producerMultipliers) g.producerMultipliers = {};
                g.producerMultipliers['factory'] = (g.producerMultipliers['factory'] || 1) * 1001;
            }
        },
        // Tree 2
        {
            id: 'art_tree2_root',
            name: 'Áî£Ê•≠Èù©ÂëΩ',
            desc: 'Â∑•Â†¥„ÅÆÁîüÁî£ +100%',
            cost: 1,
            currency: 'RP',
            x: 50,
            y: 15,
            parent: null,
            icon: 'üè≠',
            treeId: 2,
            apply: (g) => {
                if (!g.producerMultipliers) g.producerMultipliers = {};
                g.producerMultipliers['factory'] = (g.producerMultipliers['factory'] || 1) * 2;
            }
        },
        {
            id: 'art_screw',
            name: 'Ëá™ÂãïÂåñ„ÅÆ„Éç„Ç∏',
            desc: 'Áü•ÊÅµÔºà„Ç¢„ÉÉ„Éó„Ç∞„É¨„Éº„ÉâÔºâ„ÇÇËá™Âãï„ÅßË≥ºÂÖ• / On/OffÂèØËÉΩ',
            cost: 1,
            currency: 'RP',
            x: 50,
            y: 40,
            parent: 'art_tree2_root',
            icon: 'üî©',
            treeId: 2,
            apply: (g) => {
                g.autoUpgrade = true;
            }
        },
        // Tree 3
        {
            id: 'art_stone_phi',
            name: 'Ë≥¢ËÄÖ„ÅÆÁü≥',
            desc: 'Ë®≠ÂÆö„Åó„ÅüÈáëÈ°ç„ÅßËá™ÂãïËª¢Áîü„Åô„Çã / On/OffÂèØËÉΩ',
            cost: 1,
            currency: 'RP',
            x: 50,
            y: 70,
            parent: 'art_screw',
            icon: 'üîÆ',
            treeId: 2,
            apply: (g) => {
                g.autoReincarnate = true;
            }
        },
        // Enhanced Artifacts
        {
            id: 'art_villager_boost',
            name: 'Êùë„ÅÆÊéü',
            desc: 'Êùë‰∫∫„ÅÆÁîüÁî£ x10000',
            cost: 1,
            currency: 'RP',
            x: 75,
            y: 50,
            parent: 'art_coop',
            icon: 'üìú',
            treeId: 1,
            apply: (g) => {
                if (!g.producerMultipliers) g.producerMultipliers = {};
                g.producerMultipliers['villager'] = (g.producerMultipliers['villager'] || 1) * 10001;
            }
        },
        {
            id: 'art_miner_boost',
            name: 'Ê∑±Â±§Êé°Êéò',
            desc: 'Êé°ÊéòËÄÖ„ÅÆÁîüÁî£ x1000',
            cost: 1,
            currency: 'RP',
            x: 10,
            y: 60,
            parent: 'art_iron',
            icon: 'üî¶',
            treeId: 1,
            apply: (g) => {
                if (!g.producerMultipliers) g.producerMultipliers = {};
                g.producerMultipliers['miner'] = (g.producerMultipliers['miner'] || 1) * 1001;
            }
        },
        {
            id: 'art_coal_boost',
            name: 'Èªí„ÅÑ„ÉÄ„Ç§„É§„É¢„É≥„Éâ',
            desc: 'ÁÇ≠Èâ±„ÅÆÁîüÁî£ x500',
            cost: 1,
            currency: 'RP',
            x: 30,
            y: 40,
            parent: 'art_tree2_root',
            icon: 'üíé',
            treeId: 2,
            apply: (g) => {
                if (!g.producerMultipliers) g.producerMultipliers = {};
                g.producerMultipliers['coal_mine'] = (g.producerMultipliers['coal_mine'] || 1) * 501;
            }
        },
        {
            id: 'art_steam_boost',
            name: 'Ëí∏Ê∞ó„ÅÆÂäõ',
            desc: 'Ëí∏Ê∞óÊ©üÈñ¢„ÅÆÁîüÁî£ x500',
            cost: 1,
            currency: 'RP',
            x: 30,
            y: 60,
            parent: 'art_coal_boost',
            icon: '‚ô®Ô∏è',
            treeId: 2,
            apply: (g) => {
                if (!g.producerMultipliers) g.producerMultipliers = {};
                g.producerMultipliers['steam_engine'] = (g.producerMultipliers['steam_engine'] || 1) * 501;
            }
        },
        {
            id: 'art_oil_boost',
            name: 'Èªí„ÅÑÈáë',
            desc: 'Ê≤πÁî∞„ÅÆÁîüÁî£ x100',
            cost: 1,
            currency: 'RP',
            x: 30,
            y: 80,
            parent: 'art_steam_boost',
            icon: 'üß¥',
            treeId: 2,
            apply: (g) => {
                if (!g.producerMultipliers) g.producerMultipliers = {};
                g.producerMultipliers['oil_field'] = (g.producerMultipliers['oil_field'] || 1) * 101;
            }
        },
        // Enhanced Automation
        {
            id: 'art_smart_gear',
            name: 'Ë≥¢„ÅÑÊ≠ØËªä',
            desc: 'Ëá™ÂãïË≥ºÂÖ•„Åå„ÄåÊúÄÂ§ßÊï∞Ë≥ºÂÖ•„Äç„Å´ÈÄ≤Âåñ„Åô„Çã',
            cost: 5,
            currency: 'RP',
            x: 45,
            y: 95,
            parent: 'art_manager',
            icon: '‚öô',
            treeId: 1,
            apply: (g) => {
                g.autoBuyMax = true;
            }
        },
        {
            id: 'art_manipulator',
            name: '„Éû„Éã„Éî„É•„É¨„Éº„Çø',
            desc: 'ÊåáÂÆö„Åó„ÅüË®≠ÂÇô„ÇíÊåáÂÆö„Åó„ÅüÊï∞„Åæ„ÅßËá™Âãï„ÅßË≥ºÂÖ•„Åô„Çã',
            cost: 10,
            currency: 'RP',
            x: 45,
            y: 65,
            parent: 'art_smart_gear',
            icon: 'ü¶æ',
            treeId: 1,
            apply: (g) => {
                g.autoManipulator = true;
            }
        },
        {
            id: 'art_smart_manipulator',
            name: 'Ë≥¢„ÅÑ„Éû„Éã„Éî„É•„É¨„Éº„Çø',
            desc: '„Éû„Éã„Éî„É•„É¨„Éº„Çø„ÅåÁõÆÊ®ô„Åæ„Åß‰∏ÄÊã¨Ë≥ºÂÖ•„Åô„Çã',
            cost: 20,
            currency: 'RP',
            x: 45,
            y: 55,
            parent: 'art_manipulator',
            icon: 'ü¶æ',
            treeId: 1,
            apply: (g) => {
                g.autoManipulatorMax = true;
            }
        },
        // Reincarnation Start Bonus
        {
            id: 'art_heaven_gift',
            name: 'Â§©„Åã„Çâ„ÅÆÈ§ûÂà•',
            desc: 'Blessing for you',
            cost: 10,
            currency: 'RP',
            x: 50,
            y: 90,
            parent: 'art_stone_phi',
            icon: 'üéÅ',
            treeId: 2,
            apply: (g) => {
                g.money += 499999999;
            }
        }, {
            id: 'art_heaven_gift2',
            name: 'Â§©„Åã„Çâ„ÅÆË¥à„ÇäÁâ©',
            desc: 'Blessing for you',
            cost: 10000000,
            currency: 'RP',
            x: 65,
            y: 90,
            parent: 'art_heaven_gift',
            icon: 'üéÅ',
            treeId: 2,
            apply: (g) => {
                g.money += 1;
            }
        },
        {
            id: 'art_matrix',
            name: '„Éû„Éà„É™„ÇØ„ÇπÂÜçÂÆöÁæ©',
            desc: 'Ëª¢ÁîüÊôÇ„ÅÆÁç≤ÂæóRP„Åå10„Å´„Å™„Çã',
            cost: 10,
            currency: 'RP',
            x: 75,
            y: 70,
            parent: 'art_stone_phi',
            icon: '‚≠ê',
            treeId: 2,
            apply: (g) => {
                g.matrixRedefinition = true;
            }
        },
        // Custom User Artifacts
        {
            id: 'art_a',
            name: '„ÅÇ',
            desc: 'ÂÖ®ÁîüÁî£ x10000,000',
            cost: 1,
            currency: 'RP',
            x: 82,
            y: 70,
            parent: 'art_matrix',
            icon: '„ÅÇ',
            treeId: 2,
            apply: (g) => {
                g.globalMultiplier *= 1000000;
            }
        },
        {
            id: 'art_i',
            name: '„ÅÑ',
            desc: 'ÂÖ®ÁîüÁî£ x10000,000',
            cost: 1,
            currency: 'RP',
            x: 89,
            y: 70,
            parent: 'art_a',
            icon: '„ÅÑ',
            treeId: 2,
            apply: (g) => {
                g.globalMultiplier *= 10000000;
            }
        },
        {
            id: 'art_u',
            name: '„ÅÜ',
            desc: 'ÂÖ®ÁîüÁî£ ',
            cost: 1,
            currency: 'RP',
            x: 96,
            y: 70,
            parent: 'art_i',
            icon: '„ÅÜ',
            treeId: 2,
            apply: (g) => {
                g.globalMultiplier *= 10000000000;
            }
        }];

        const defaultAchievements = [{

            id: 'firstZ',
            name: 'ÊúÄÂàù„ÅÆ10Z',
            desc: 'Z„Çí10Áç≤Âæó',
            condition: gs => gs.totalZ >= 10,
            rewarded: false,
            reward: gs => {
                gs.money += 200000000000
            }
        }

            ,
        {

            id: 'hundredZ',
            name: 'Z„Çí100Áç≤Âæó',
            desc: 'Z„Çí100Áç≤Âæó',
            condition: gs => gs.totalZ >= 100,
            rewarded: false,
            reward: gs => {
                gs.globalMultiplier *= 1.10
            }
        }

            ,
        {

            id: 'hireOne',
            name: 'Êùë‰∫∫„ÇíÈõá„ÅÜ',
            desc: 'Êùë‰∫∫„Çí1‰∫∫Èõá„ÅÜ',
            condition: gs => producers.find(p => p.id === 'villager').count >= 1,
            rewarded: false,
            reward: gs => {
                gs.money += 5
            }
        },
        {
            id: 'hire999',
            name: 'Lv999„ÅÆÊùë‰∫∫',
            desc: '???',
            condition: gs => producers.find(p => p.id === 'villager').count >= 999,
            rewarded: false,
            reward: gs => {
                if (!gs.producerMultipliers) gs.producerMultipliers = {};
                gs.producerMultipliers['villager'] = (gs.producerMultipliers['villager'] || 1) * 999999999999;
            }
        },
        {
            id: 'steam_engine_unlock',
            name: 'Ëí∏Ê∞ó„ÅÆÊôÇ‰ª£',
            desc: 'Ëí∏Ê∞óÊ©üÈñ¢„Çí1„Å§Ë≥ºÂÖ•„Åô„Çã',
            condition: gs => producers.find(p => p.id === 'steam_engine').count >= 1,
            rewarded: false,
            reward: gs => {
                gs.globalMultiplier *= 1.20;
            }
        },
        {
            id: 'energy_rev',
            name: 'Á¨¨‰∏ÄÊ¨°„Ç®„Éç„É´„ÇÆ„ÉºÈù©ÂëΩ',
            desc: 'Ê≤πÁî∞„Çí1„Å§Ë≥ºÂÖ•„Åô„ÇãÔºàÁü≥ÁÇ≠„Åã„ÇâÁü≥Ê≤π„Å∏Ôºâ',
            condition: gs => producers.find(p => p.id === 'oil_field').count >= 1,
            rewarded: false,
            reward: gs => {
                gs.globalMultiplier *= 1.50;
            }
        },
        {
            id: 'oil_tycoon',
            name: 'Áü≥Ê≤πÁéã',
            desc: 'Ê≤πÁî∞„Çí10ÂÄãÊâÄÊåÅ„Åô„Çã',
            condition: gs => producers.find(p => p.id === 'oil_field').count >= 10,
            rewarded: false,
            reward: gs => {
                gs.money += 1000000000;
            }
        }

        ];

        const defaultChallenges = [
            {
                id: 'c_domain',
                name: 'È†òÂüüÂ±ïÈñã',
                desc: '100ÂõûËª¢Áîü„Åô„Çã',
                condition: (g) => g.reincarnationCount >= 100,
                rewardMP: 10,
                cleared: false
            },
            {
                id: 'c_villager',
                name: 'Êùë‰∫∫„ÅÆÂßã„Åæ„Çä',
                desc: 'Êùë‰∫∫„ÅÆ„ÅøË≥ºÂÖ•„Åó„Å¶ÊâÄÊåÅÈáë 1e+15 „Å´Âà∞ÈÅî',
                condition: (g) => {
                    if (g.money < 1e15) return false;
                    const v = producers.find(p => p.id === 'villager');
                    if (!v || v.count === 0) return false;
                    const others = producers.filter(p => p.id !== 'villager');
                    return others.every(p => p.count === 0);
                },
                rewardMP: 50,
                cleared: false
            }
        ];

        /* ----- „Ç≤„Éº„É†Áä∂ÊÖãÔºàÂèØÂ§âÔºâ ----- */

        // Èñ¢Êï∞„Çí‰øù„Å£„Åü„Åæ„Åæ„Ç≥„Éî„Éº„Åô„ÇãÔºàJSONÁ≥ª„ÅØÈñ¢Êï∞„ÇíÊ∂à„Åô„ÅÆ„Åß‰Ωø„Çè„Å™„ÅÑÔºâ
        let producers = defaultProducers.map(p => ({
            ...p
        }));

        let upgrades = defaultUpgrades.map(u => ({
            ...u
        }));

        let challenges = defaultChallenges.map(c => ({
            ...c
        }));

        let artifacts = defaultArtifacts.map(a => ({
            ...a, bought: false
        }));

        let achievements = defaultAchievements.map(a => ({
            ...a
        }));



        let gameState = {

            money: 0,
            mp: 0,
            totalZ: 0,
            clickPower: 1,
            globalMultiplier: 1,
            producerMultipliers: {}

            ,
            playTimeSec: 0,
            reincarnationCount: 0,
            prestigeMultiplier: 1.0,
            reincarnationPoints: 0,
            autoBuyActive: true,
            autoUpgrade: false,
            autoUpgradeActive: false,
            autoReincarnate: false,
            autoReincarnateActive: false,
            autoReincarnateThreshold: 0,
            isEmergencyStop: false,
            matrixRedefinition: false,
            lastTick: Date.now()
        }

            ;

        /* ----- „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÁî®„Çø„Ç§„É†„Çπ„Çø„É≥„ÉóÔºàrAF„ÅåÊ≠¢„Åæ„Å£„Åü„ÅãÂà§ÂÆö„Åô„Çã„Åü„ÇÅÔºâ ----- */
        let _lastTickTime = Date.now();

        /* ----- „É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£Èñ¢Êï∞ ----- */
        function formatNum(n) {
            if (!isFinite(n)) return '0';
            if (n >= 1e15) return n.toExponential(2);
            if (n >= 1e12) return (n / 1e12).toFixed(2) + 'T';
            if (n >= 1e9) return (n / 1e9).toFixed(2) + 'B';
            if (n >= 1e6) return (n / 1e6).toFixed(2) + 'M';
            if (n >= 1000) return (n / 1000).toFixed(2) + 'k';
            if (Math.abs(n - Math.round(n)) < 1e-9) return String(Math.round(n));
            return Number(n.toFixed(2)).toString();
        }

        function calcProdPerSecond() {
            let sum = 0;

            for (const p of producers) {
                let mult = 1;

                if (gameState.producerMultipliers && gameState.producerMultipliers[p.id]) {
                    mult = gameState.producerMultipliers[p.id];
                }

                sum += (p.count || 0) * p.baseProd * mult;
            }

            sum *= gameState.globalMultiplier;
            sum *= (gameState.prestigeMultiplier || 1);
            return sum;
        }

        function nextCost(p) {
            return Math.floor(p.baseCost * Math.pow(p.costMult, p.count));
        }

        function calcMaxAffordable(p, money) {
            if (money < nextCost(p)) return 0;
            const r = p.costMult;
            const a = nextCost(p);
            // Sum = a * (r^n - 1) / (r - 1) <= money
            // r^n <= money * (r - 1) / a + 1
            // n <= log_r( ... )
            const n = Math.floor(Math.log(money * (r - 1) / a + 1) / Math.log(r));
            return n;
        }

        function buyProducerMax(id) {
            const p = producers.find(x => x.id === id);
            if (!p) return;
            const max = calcMaxAffordable(p, gameState.money);
            if (max <= 0) {
                flashInsufficient();
                return;
            }

            // Loop to buy one by one to trigger bonuses properly
            // (Optimization: In a real heavy game, we would calculate sums, but for this scale, a loop is fine)
            // Actually, let's just do it in a loop to ensure all "every 10th" logic fires correctly.
            // However, for "Max" which could be 100s, let's cap it or ensure it's performant? 
            // Javascript loop of 1000 is instant.
            for (let i = 0; i < max; i++) {
                const cost = nextCost(p);
                if (gameState.money < cost) break; // Should not happen if calculation is correct
                gameState.money -= cost;
                p.count += 1;
                if (p.count % 10 === 0) {
                    gameState.money += Math.floor(p.baseProd * 5 * gameState.globalMultiplier);
                }
            }

            try {
                checkAchievements();
            } catch (e) {
                console.error(e);
            }
            updateUI();
        }

        /* ----- UI Êõ¥Êñ∞Âá¶ÁêÜÔºàË°®Á§∫„ÇíÊúÄÊñ∞ÂåñÔºâ ----- */
        function updateUI() {
            const elMoney = document.getElementById('money');
            if (elMoney) elMoney.textContent = formatNum(gameState.money);
            const elZps = document.getElementById('zps');
            if (elZps) elZps.textContent = formatNum(calcProdPerSecond()) + ' Z/s';
            const elTotal = document.getElementById('totalZ');
            if (elTotal) elTotal.textContent = formatNum(gameState.totalZ);
            const elPlay = document.getElementById('playTime');
            if (elPlay) elPlay.textContent = Math.floor(gameState.playTimeSec) + 's';
            const elClick = document.getElementById('clickValue');
            if (elClick) elClick.textContent = formatNum(gameState.clickPower) + ' Z';
            const vill = producers.find(p => p.id === 'villager');
            const elNextVill = document.getElementById('nextVillagerCost');
            if (elNextVill) elNextVill.textContent = vill ? formatNum(nextCost(vill)) : '--';

            const elRein = document.getElementById('reincarnationCount');
            if (elRein) elRein.textContent = gameState.reincarnationCount || 0;
            const elPrestige = document.getElementById('prestigeMult');
            if (elPrestige) elPrestige.textContent = 'x' + (gameState.prestigeMultiplier || 1).toFixed(2);
            const elRP = document.getElementById('rpValue');
            if (elRP) elRP.textContent = gameState.reincarnationPoints || 0;

            // Auto Buy Toggle
            const autoPanel = document.getElementById('automationPanel');
            const autoToggle = document.getElementById('autoBuyToggle');
            const autoUpRow = document.getElementById('autoUpgradeRow');
            const autoUpToggle = document.getElementById('autoUpgradeToggle');
            const autoReincRow = document.getElementById('autoReincarnateRow');
            const autoReincToggle = document.getElementById('autoReincarnateToggle');
            const autoReincInput = document.getElementById('autoReincarnateInput');

            if (autoPanel) {
                let show = false;
                if (gameState.autoBuy) {
                    show = true;
                    if (autoToggle) {
                        if (!autoToggle._init) {
                            autoToggle.addEventListener('change', (e) => gameState.autoBuyActive = e.target.checked);
                            autoToggle._init = true;
                        }
                        if (autoToggle.checked !== !!gameState.autoBuyActive) autoToggle.checked = !!gameState.autoBuyActive;
                    }
                }

                if (gameState.autoUpgrade) {
                    show = true;
                    if (autoUpRow) autoUpRow.style.display = 'flex';
                    if (autoUpToggle) {
                        if (!autoUpToggle._init) {
                            autoUpToggle.addEventListener('change', (e) => gameState.autoUpgradeActive = e.target.checked);
                            autoUpToggle._init = true;
                        }
                        if (autoUpToggle.checked !== !!gameState.autoUpgradeActive) autoUpToggle.checked = !!gameState.autoUpgradeActive;
                    }
                } else {
                    if (autoUpRow) autoUpRow.style.display = 'none';
                }

                if (gameState.autoReincarnate) {
                    show = true;
                    if (autoReincRow) autoReincRow.style.display = 'flex';
                    if (autoReincToggle) {
                        if (!autoReincToggle._init) {
                            autoReincToggle.addEventListener('change', (e) => gameState.autoReincarnateActive = e.target.checked);
                            autoReincToggle._init = true;
                        }
                        if (autoReincToggle.checked !== !!gameState.autoReincarnateActive) autoReincToggle.checked = !!gameState.autoReincarnateActive;
                    }
                    if (autoReincInput) {
                        if (!autoReincInput._init) {
                            autoReincInput.addEventListener('change', (e) => {
                                const val = parseFloat(e.target.value);
                                gameState.autoReincarnateThreshold = isFinite(val) ? val : 0;
                            });
                            autoReincInput._init = true;
                        }
                        // Only update input value if it's not focused to avoid annoying user while typing
                        if (document.activeElement !== autoReincInput) {
                            autoReincInput.value = gameState.autoReincarnateThreshold || '';
                        }
                    }
                } else {
                    if (autoReincRow) autoReincRow.style.display = 'none';
                }

                // Manipulator UI
                const autoManiRow = document.getElementById('autoManipulatorRow');
                const autoManiToggle = document.getElementById('autoManipulatorToggle');
                const autoManiSelect = document.getElementById('autoManipulatorSelect');
                const autoManiCap = document.getElementById('autoManipulatorCap');

                if (gameState.autoManipulator) {
                    show = true;
                    if (autoManiRow) autoManiRow.style.display = 'flex';

                    // Populate select if empty (first run)
                    if (autoManiSelect && autoManiSelect.options.length <= 1) {
                        producers.forEach(p => {
                            const opt = document.createElement('option');
                            opt.value = p.id;
                            opt.textContent = p.name;
                            autoManiSelect.appendChild(opt);
                        });
                    }

                    if (autoManiToggle) {
                        if (!autoManiToggle._init) {
                            autoManiToggle.addEventListener('change', (e) => gameState.autoManipulatorActive = e.target.checked);
                            autoManiToggle._init = true;
                        }
                        if (autoManiToggle.checked !== !!gameState.autoManipulatorActive) autoManiToggle.checked = !!gameState.autoManipulatorActive;
                    }

                    if (autoManiSelect) {
                        if (!autoManiSelect._init) {
                            autoManiSelect.addEventListener('change', (e) => gameState.autoManipulatorTarget = e.target.value);
                            autoManiSelect._init = true;
                        }
                        if (document.activeElement !== autoManiSelect) {
                            autoManiSelect.value = gameState.autoManipulatorTarget || '';
                        }
                    }

                    if (autoManiCap) {
                        if (!autoManiCap._init) {
                            autoManiCap.addEventListener('change', (e) => {
                                const val = parseInt(e.target.value);
                                gameState.autoManipulatorCap = isFinite(val) ? val : 0;
                            });
                            autoManiCap._init = true;
                        }
                        if (document.activeElement !== autoManiCap) {
                            autoManiCap.value = gameState.autoManipulatorCap || '';
                        }
                    }

                } else {
                    if (autoManiRow) autoManiRow.style.display = 'none';
                }

                autoPanel.style.display = show ? 'block' : 'none';
            }

            // Reset Button Text
            const resetBtn = document.getElementById('resetBtn');

            if (resetBtn) {
                if (gameState.money >= 1000000) {
                    resetBtn.textContent = 'Ëª¢Áîü„Åô„Çã';
                    resetBtn.style.background = 'linear-gradient(180deg, #f59e0b, #d97706)';
                    resetBtn.style.borderColor = '#f59e0b';
                }

                else {
                    resetBtn.textContent = '„É™„Çª„ÉÉ„Éà';
                    resetBtn.style.background = '#7f1d1d';
                    resetBtn.style.borderColor = '#7f1d1d';
                }
            }

            // Emergency Stop Button UI
            const emBtn = document.getElementById('emergencyStopBtn');
            if (emBtn) {
                if (gameState.isEmergencyStop) {
                    emBtn.textContent = 'Á∑äÊÄ•ÂÅúÊ≠¢‰∏≠ („ÇØ„É™„ÉÉ„ÇØ„ÅßÂÜçÈñã)';
                    emBtn.style.background = '#ef4444'; // Red
                    emBtn.style.color = '#fff';
                    emBtn.style.borderColor = '#ef4444';
                } else {
                    emBtn.textContent = 'Á∑äÊÄ•ÂÅúÊ≠¢ (Ëá™ÂãïÂåñOFF)';
                    emBtn.style.background = 'transparent';
                    emBtn.style.color = '#f59e0b';
                    emBtn.style.borderColor = '#f59e0b';
                }

                if (!emBtn._init) {
                    emBtn.onclick = () => {
                        gameState.isEmergencyStop = !gameState.isEmergencyStop;
                        updateUI();
                    };
                    emBtn._init = true;
                }
            }

            renderMonoPanel();
            renderChiePanel();
            renderAchPanel();
            renderArtifactTree();
        }

        /* ----- „É°„Ç§„É≥Âá¶ÁêÜÔºöÊôÇÈñìÁµåÈÅé„Å®ÁîüÁî£Ôºà„Ç≤„Éº„É†„É´„Éº„ÉóÔºâ ----- */
        function tick(dt) {
            // rAF„ÅåÊ≠£Â∏∏„Å´Âãï„ÅÑ„Å¶„ÅÑ„Çã„Åì„Å®„ÇíÁ§∫„Åô„Çø„Ç§„É†„Çπ„Çø„É≥„ÉóÊõ¥Êñ∞
            _lastTickTime = Date.now();

            const prod = calcProdPerSecond();
            const gain = prod * dt;

            gameState.money += gain;
            gameState.totalZ += gain;
            gameState.playTimeSec += dt;

            // Auto Buy Logic
            // EMERGENCY STOP CHECK
            if (!gameState.isEmergencyStop) {
                if (gameState.autoBuy && gameState.autoBuyActive) {
                    // Prioritize highest tier affordable
                    for (let i = producers.length - 1; i >= 0; i--) {
                        const p = producers[i];
                        if (gameState.money >= nextCost(p)) {
                            if (gameState.autoBuyMax) {
                                buyProducerMax(p.id);
                            } else {
                                buyProducer(p.id);
                            }
                            break; // Buy only one per tick to respect priority
                        }
                    }
                }

                // Manipulator Logic
                if (gameState.autoManipulator && gameState.autoManipulatorActive) {
                    const limit = gameState.autoManipulatorCap || 0;
                    const targetId = gameState.autoManipulatorTarget;
                    if (targetId && limit > 0) {
                        const p = producers.find(x => x.id === targetId);
                        if (p && p.count < limit) {
                            // Buy if affordable
                            if (gameState.autoManipulatorMax) {
                                // Smart Logic: Buy up to limit or max affordable
                                const needed = limit - p.count;
                                const affordable = calcMaxAffordable(p, gameState.money);
                                const count = Math.min(needed, affordable);
                                if (count > 0) {
                                    // Loop buy to ensure triggers fire properly
                                    for (let k = 0; k < count; k++) buyProducer(p.id);
                                }
                            } else {
                                // Normal Logic
                                if (gameState.money >= nextCost(p)) {
                                    buyProducer(p.id);
                                }
                            }
                        }
                    }
                }

                // Auto Upgrade Logic
                if (gameState.autoUpgrade && gameState.autoUpgradeActive) {
                    // Try to buy unbought upgrades if affordable
                    for (const u of upgrades) {
                        if (!u.bought && gameState.money >= u.cost) {
                            buyUpgrade(u.id);
                        }
                    }
                }

                // Auto Reincarnate Logic
                if (gameState.autoReincarnate && gameState.autoReincarnateActive && gameState.autoReincarnateThreshold > 0) {
                    // Minimum limit is 1e20 as per request
                    const effectiveThreshold = Math.max(gameState.autoReincarnateThreshold, 1e20);
                    if (gameState.money >= effectiveThreshold) {
                        resetGame();
                    }
                }
            } // End of Emergency Stop Check

            checkAchievements();
            checkChallenges();
        }

        /* ----- „É¢„ÉéÔºà„Éó„É≠„Éá„É•„Éº„ÇµÔºâ„Éë„Éç„É´„ÅÆÊèèÁîª„Å®Ë≥ºÂÖ•Âá¶ÁêÜ ----- */
        function renderMonoPanel() {
            const container = document.getElementById('monoPanel');
            if (!container) return;
            container.innerHTML = '';

            for (const p of producers) {
                const el = document.createElement('div');
                el.className = 'producer';

                const maxBuy = calcMaxAffordable(p, gameState.money);

                el.innerHTML = ` <div class="left"><div style="font-size:20px">${p.icon
                    }

        </div><div><div class="name">${p.name
                    }

        <span style="font-size:12px;color:var(--muted)">x${p.count
                    }

        </span></div><div class="meta">ÁîüÁî£: ${formatNum(p.baseProd)
                    }

        Z/s</div></div></div><div style="text-align:right"><div style="font-size:13px;color:var(--muted)">‰æ°Ê†º</div><div style="font-weight:700">${formatNum(nextCost(p))
                    }

        Z</div><div style="margin-top:8px; display:flex; gap:4px; justify-content:flex-end">
            <button class="buy-btn" data-id="${p.id}"${gameState.money < nextCost(p) ? 'disabled' : ''
                    }>Ë≥ºÂÖ•</button>
            <button class="buy-btn" data-id-max="${p.id}"${maxBuy <= 0 ? 'disabled' : ''
                    }>Max (+${maxBuy})</button>
        </div></div>`;
                container.appendChild(el);
            }

            container.querySelectorAll('button[data-id]').forEach(b => {
                b.onclick = () => {
                    const id = b.getAttribute('data-id');
                    buyProducer(id);
                }
            });

            container.querySelectorAll('button[data-id-max]').forEach(b => {
                b.onclick = () => {
                    const id = b.getAttribute('data-id-max');
                    buyProducerMax(id);
                }
            });
        }

        function buyProducer(id) {
            const p = producers.find(x => x.id === id);
            if (!p) return;
            const cost = nextCost(p);

            if (gameState.money >= cost) {
                gameState.money -= cost;
                p.count += 1;

                if (p.count % 10 === 0) {
                    gameState.money += Math.floor(p.baseProd * 5 * gameState.globalMultiplier);
                }

                // ÂÆüÁ∏æÂà§ÂÆö„ÇíÁ¢∫ÂÆü„Å´Ë°å„ÅÜÔºàË≥ºÂÖ•„ÅßÈÅîÊàê„Åô„ÇãÂèØËÉΩÊÄß„Åå„ÅÇ„Çã„Åü„ÇÅÔºâ
                try {
                    checkAchievements();
                }

                catch (e) {
                    console.error(e);
                }

                updateUI();

            }

            else {
                flashInsufficient();
            }
        }

        /* ----- „Ç¢„ÉÉ„Éó„Ç∞„É¨„Éº„ÉâÔºàÁü•ÊÅµÔºâ ----- */
        function renderChiePanel() {
            const container = document.getElementById('tabContent');
            if (!container) return;
            if (currentTab !== 'chie') return;

            const panel = document.createElement('div');
            panel.id = 'chiePanel';

            if (upgrades.length === 0) {
                panel.textContent = '„Ç¢„ÉÉ„Éó„Ç∞„É¨„Éº„Éâ„ÅØ„Åæ„Å†„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ';
            }

            else {
                for (const u of upgrades) {
                    const d = document.createElement('div');
                    d.className = 'upgrade';

                    d.innerHTML = ` <div><div style="font-weight:700">${u.name
                        }

            ${u.bought ? 'ÔºàË≥ºÂÖ•Ê∏àÔºâ' : ''
                        }

            </div><div style="font-size:13px;color:var(--muted)">${u.desc
                        }

            </div></div><div style="text-align:right"><div style="font-size:13px;color:var(--muted)">‰æ°Ê†º</div><div style="font-weight:700">${formatNum(u.cost)
                        }

            Z</div><div style="margin-top:8px"><button class="buy-btn" data-upg="${u.id}"${u.bought || gameState.money < u.cost ? 'disabled' : ''
                        }

            >Ë≥ºÂÖ•</button></div></div>`;
                    panel.appendChild(d);
                }
            }

            container.innerHTML = '';
            container.appendChild(panel);

            container.querySelectorAll('.buy-btn').forEach(b => {
                b.onclick = () => {
                    const id = b.getAttribute('data-upg');
                    buyUpgrade(id);
                }
            });
        }

        function buyUpgrade(id) {
            const u = upgrades.find(x => x.id === id);
            if (!u || u.bought) return;

            if (gameState.money >= u.cost) {
                gameState.money -= u.cost;
                u.bought = true;

                try {
                    u.apply(gameState);
                }

                catch (e) {
                    console.error(e)
                }

                // ÂÆüÁ∏æÂà§ÂÆöÔºà„Ç¢„ÉÉ„Éó„Ç∞„É¨„Éº„Éâ„ÅßÊù°‰ª∂„ÅåÊ∫Ä„Åü„Åï„Çå„ÇãÂ†¥Âêà„Åå„ÅÇ„ÇãÔºâ
                try {
                    checkAchievements();
                }

                catch (e) {
                    console.error(e)
                }

                updateUI();
            }

            else flashInsufficient();
        }

        /* ----- „Ç¢„Éº„ÉÜ„Ç£„Éï„Ç°„ÇØ„ÉàÔºà„Çπ„Ç≠„É´„ÉÑ„É™„ÉºÔºâ ----- */
        let currentTreeId = 1;

        function renderArtifactTree() {
            const svg = document.getElementById('treeSvg');
            const nodesContainer = document.getElementById('treeNodes');
            const tooltip = document.getElementById('artifactTooltip');
            if (!svg || !nodesContainer) return;

            // Tabs handling
            document.querySelectorAll('.tree-tab').forEach(t => {
                const tid = parseInt(t.dataset.tree);
                if (tid === currentTreeId) t.classList.add('active');
                else t.classList.remove('active');

                t.onclick = () => {
                    currentTreeId = tid;
                    renderArtifactTree();
                }
            });

            if (currentTreeId === 3) {
                renderChallengePanel();
                return;
            }

            // Filter artifacts
            const treeArtifacts = defaultArtifacts.filter(a => (a.treeId || 1) === currentTreeId);

            // Clear previous
            svg.innerHTML = '';
            nodesContainer.innerHTML = '';

            // Draw connections
            treeArtifacts.forEach(art => {
                if (art.parent) {
                    const parent = treeArtifacts.find(p => p.id === art.parent);

                    if (parent) {
                        const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                        line.setAttribute('x1', parent.x + '%');
                        line.setAttribute('y1', parent.y + '%');
                        line.setAttribute('x2', art.x + '%');
                        line.setAttribute('y2', art.y + '%');

                        // Line color based on state
                        const artState = artifacts.find(a => a.id === art.id);
                        const parentState = artifacts.find(a => a.id === parent.id);
                        const isUnlocked = parentState && parentState.bought;
                        const isBought = artState && artState.bought;

                        line.setAttribute('stroke', isBought ? '#0ea5e9' : (isUnlocked ? '#4b5563' : '#1f2937'));
                        line.setAttribute('stroke-width', '2');
                        svg.appendChild(line);
                    }
                }
            });

            // Draw nodes
            treeArtifacts.forEach(art => {
                const def = art; // alias for clarity
                const el = document.createElement('div');
                el.className = 'artifact-node';
                el.style.left = def.x + '%';
                el.style.top = def.y + '%';
                el.textContent = def.icon;

                // Determine state
                const artState = artifacts.find(a => a.id === def.id);
                const isBought = artState && artState.bought;
                let isLocked = false;

                if (def.parent) {
                    const parentState = artifacts.find(p => p.id === def.parent);
                    if (!parentState || !parentState.bought) isLocked = true;
                }

                if (isBought) {
                    el.classList.add('bought');
                } else if (isLocked) {
                    el.classList.add('locked');
                } else {
                    el.classList.add('available');
                }

                // Interaction
                el.onclick = () => buyArtifact(def.id);

                // Tooltip
                el.onmouseenter = () => {
                    const costText = def.currency === 'RP' ? `${def.cost} RP` : `${formatNum(def.cost)} Z`;
                    tooltip.style.display = 'block';
                    tooltip.innerHTML = `
                        <div style="font-weight:700;color:${isBought ? '#7dd3fc' : '#fff'}">${def.name}</div>
                        <div style="color:#ccc">${def.desc}</div>
                        ${!isBought ? `<div style="margin-top:4px;font-weight:700;color:${isLocked ? '#ef4444' : '#fbbf24'}">Cost: ${costText}</div>` : ''}
                    `;
                };
                el.onmouseleave = () => {
                    tooltip.style.display = 'none';
                };

                nodesContainer.appendChild(el);
            });
        }

        function buyArtifact(id) {
            const art = artifacts.find(a => a.id === id);
            const def = defaultArtifacts.find(d => d.id === id);
            if (!art || !def || art.bought) return;

            // Check parent
            if (def.parent) {
                const parent = artifacts.find(p => p.id === def.parent);

                if (!parent || !parent.bought) {
                    notify('Ë¶™„Ç¢„Éº„ÉÜ„Ç£„Éï„Ç°„ÇØ„Éà„ÅåÂøÖË¶Å„Åß„Åô');
                    return;
                }
            }

            const currency = def.currency || 'Z';
            const cost = def.cost;

            if (currency === 'RP') {
                if ((gameState.reincarnationPoints || 0) >= cost) {
                    gameState.reincarnationPoints = (gameState.reincarnationPoints || 0) - cost;
                    art.bought = true;
                    try {
                        def.apply(gameState);
                    } catch (e) {
                        console.error(e);
                    }
                    notify(`„Ç¢„Éº„ÉÜ„Ç£„Éï„Ç°„ÇØ„ÉàÁç≤Âæó: ${def.name}`);
                    updateUI();
                } else {
                    notify('Ëª¢Áîü„Éù„Ç§„É≥„Éà„ÅåË∂≥„Çä„Åæ„Åõ„Çì');
                }
                return;
            }

            if (gameState.money >= cost) {
                gameState.money -= cost;
                art.bought = true;

                try {
                    def.apply(gameState);
                }

                catch (e) {
                    console.error(e);
                }

                notify(`„Ç¢„Éº„ÉÜ„Ç£„Éï„Ç°„ÇØ„ÉàÁç≤Âæó: ${def.name
                    }

            `);
                updateUI();
            }

            else {
                flashInsufficient();
            }
        }

        function renderAchPanel() {
            const container = document.getElementById('tabContent');
            if (!container) return;
            if (currentTab !== 'ach') return;

            const panel = document.createElement('div');
            panel.id = 'achPanel';

            for (const a of achievements) {
                const d = document.createElement('div');
                d.className = 'ach ' + (a.rewarded ? 'unlocked' : 'locked');

                d.innerHTML = ` <div><div style="font-weight:700">${a.name
                    }

        </div><div style="font-size:13px;color:var(--muted)">${a.desc
                    }

        </div></div><div style="text-align:right"><div style="font-size:13px;color:${a.rewarded ? '#a6f3c5' : 'var(--muted)'}">${a.rewarded ? 'Áç≤ÂæóÊ∏à' : 'Êú™ÈÅîÊàê'
                    }

        </div></div>`;
                panel.appendChild(d);
            }

            container.innerHTML = '';
            container.appendChild(panel);
        }

        function checkAchievements() {
            let updated = false;

            for (const a of achievements) {
                try {
                    if (!a.rewarded && a.condition(gameState)) {
                        a.rewarded = true;

                        try {
                            a.reward(gameState);
                        }

                        catch (e) {
                            console.error(e)
                        }

                        updated = true;

                        notify(`ÂÆüÁ∏æËß£Èô§: ${a.name
                            }

                    `);
                    }
                }

                catch (e) {
                    console.error('ÂÆüÁ∏æÂà§ÂÆö„Ç®„É©„Éº', a.id, e);
                }
            }

            if (updated) updateUI();
        }

        /* ----- ÊåëÊà¶Ôºà„ÉÅ„É£„É¨„É≥„Ç∏Ôºâ„Ç∑„Çπ„ÉÜ„É† ----- */
        function checkChallenges() {
            let updated = false;
            for (const c of challenges) {
                if (!c.cleared && c.condition(gameState)) {
                    c.cleared = true;
                    gameState.mp = (gameState.mp || 0) + c.rewardMP;
                    notify(`ÊåëÊà¶„ÇØ„É™„Ç¢: ${c.name} (+${c.rewardMP} MP)`);
                    updated = true;
                }
            }
            if (updated) updateUI();
        }

        function renderChallengePanel() {
            const container = document.getElementById('treeNodes');
            const svg = document.getElementById('treeSvg');
            if (!container || !svg) return;

            // Clear SVG lines for challenge tab
            svg.innerHTML = '';

            // Render Challenge UI
            let html = `
                <div style="width:100%; height:100%; overflow-y:auto; padding:10px;">
                    <div style="text-align:center; margin-bottom:16px; font-size:18px; font-weight:bold; color:#d8b4fe">
                        ÁèæÂú®„ÅÆMP: ${gameState.mp || 0}
                    </div>
                    <div style="display:flex; flex-direction:column; gap:12px;">
            `;

            for (const c of challenges) {
                html += `
                    <div style="background:rgba(255,255,255,0.05); border:1px solid ${c.cleared ? '#d8b4fe' : 'rgba(255,255,255,0.1)'}; border-radius:8px; padding:12px; display:flex; justify-content:space-between; align-items:center;">
                        <div>
                            <div style="font-weight:700; color:${c.cleared ? '#d8b4fe' : '#fff'}">${c.name}</div>
                            <div style="font-size:12px; color:#aaa">${c.desc}</div>
                        </div>
                        <div style="text-align:right;">
                            <div style="font-size:14px; font-weight:bold; color:#d8b4fe">${c.rewardMP} MP</div>
                            <div style="font-size:12px; color:${c.cleared ? '#d8b4fe' : '#666'}">${c.cleared ? '„ÇØ„É™„Ç¢Ê∏à' : 'Êú™ÈÅîÊàê'}</div>
                        </div>
                    </div>
                `;
            }

            html += `</div></div>`;
            container.innerHTML = html;
        }

        /* ----- ÈÄöÁü• ----- */
        function notify(msg) {
            const n = document.createElement('div');
            n.textContent = msg;
            n.style.position = 'fixed';
            n.style.right = '20px';
            n.style.bottom = '20px';
            n.style.padding = '12px 18px';
            n.style.borderRadius = '8px';
            n.style.background = 'linear-gradient(180deg, rgba(125,211,252,0.15), rgba(125,211,252,0.08))';
            n.style.color = 'var(--accent)';
            n.style.boxShadow = '0 8px 24px rgba(0,0,0,0.5)';
            n.style.fontSize = '15px';
            n.style.fontWeight = '700';
            n.style.zIndex = '9999';
            document.body.appendChild(n);

            setTimeout(() => {
                n.style.transition = 'all 360ms ease'; n.style.opacity = '0'; n.style.transform = 'translateY(20px)';
            }

                , 2000);
            setTimeout(() => n.remove(), 2500);
        }

        /* ----- „Çª„Éº„Éñ„Éª„É≠„Éº„Éâ„Éª„É™„Çª„ÉÉ„ÉàÔºàÂÆâÂÖ®„Å™„Éû„Éº„Ç∏Ôºâ ----- */
        function saveGame() {
            const save = {
                gameState,
                producers,
                upgrades,
                artifacts,
                achievements,
                ts: Date.now()
            }

                ;

            try {
                localStorage.setItem(GAME_SAVE_KEY, JSON.stringify(save));
                notify('„Çª„Éº„Éñ„Åó„Åæ„Åó„Åü');
            }

            catch (e) {
                console.error('„Çª„Éº„ÉñÂ§±Êïó', e);
                notify('„Çª„Éº„Éñ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
            }
        }

        function loadGame(silent = false) {
            const raw = localStorage.getItem(GAME_SAVE_KEY);

            if (!raw) {
                if (!silent) notify('„Çª„Éº„Éñ„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì');
                return;
            }

            try {
                const save = JSON.parse(raw);

                if (save.gameState) {
                    gameState = Object.assign(gameState, save.gameState);
                    // Ensure new fields exist
                    if (typeof gameState.reincarnationCount === 'undefined') gameState.reincarnationCount = 0;
                    if (typeof gameState.prestigeMultiplier === 'undefined') gameState.prestigeMultiplier = 1.0;
                    if (typeof gameState.reincarnationPoints === 'undefined') gameState.reincarnationPoints = 0;
                    if (typeof gameState.autoUpgradeActive === 'undefined') gameState.autoUpgradeActive = false;
                    if (typeof gameState.autoReincarnateActive === 'undefined') gameState.autoReincarnateActive = false;
                    if (typeof gameState.autoReincarnateActive === 'undefined') gameState.autoReincarnateActive = false;
                    if (typeof gameState.autoReincarnateThreshold === 'undefined') gameState.autoReincarnateThreshold = 0;
                    if (typeof gameState.autoManipulatorActive === 'undefined') gameState.autoManipulatorActive = false;
                    if (typeof gameState.autoManipulatorTarget === 'undefined') gameState.autoManipulatorTarget = '';
                    if (typeof gameState.autoManipulatorCap === 'undefined') gameState.autoManipulatorCap = 0;
                    if (typeof gameState.matrixRedefinition === 'undefined') gameState.matrixRedefinition = false;
                }

                if (save.producers) {
                    producers = defaultProducers.map(d => {
                        const s = (save.producers || []).find(x => x.id === d.id) || {}

                            ;

                        return Object.assign({}

                            , d, {
                            count: s.count ?? d.count
                        });
                    });
                }

                if (save.upgrades) {
                    upgrades = defaultUpgrades.map(d => {
                        const s = (save.upgrades || []).find(x => x.id === d.id) || {}

                            ;

                        return Object.assign({}

                            , d, {
                            bought: s.bought ?? d.bought
                        });
                    });
                }

                if (save.artifacts) {
                    artifacts = defaultArtifacts.map(d => {
                        const s = (save.artifacts || []).find(x => x.id === d.id) || {}

                            ;

                        return Object.assign({}

                            , d, {
                            bought: s.bought ?? false
                        });
                    });
                }

                if (save.achievements) {
                    achievements = defaultAchievements.map(d => {
                        const s = (save.achievements || []).find(x => x.id === d.id) || {}

                            ;

                        return Object.assign({}

                            , d, {
                            rewarded: s.rewarded ?? d.rewarded
                        });
                    });
                }

                // „Ç™„Éï„É©„Ç§„É≥Ë£úÂ°´Ôºà‰øùÂ≠òÊôÇÂàª„Åå„ÅÇ„Çå„Å∞Â∑ÆÂàÜ„ÇíË£úÂ°´Ôºâ
                if (save.ts) {
                    const elapsedSec = Math.floor((Date.now() - save.ts) / 1000);

                    if (elapsedSec > 1) {
                        const prod = calcProdPerSecond();
                        const offlineGain = prod * elapsedSec;
                        gameState.money += offlineGain;
                        gameState.totalZ += offlineGain;
                        gameState.playTimeSec += elapsedSec;

                        notify(`ÊîæÁΩÆÂ†±ÈÖ¨: ${formatNum(offlineGain)
                            }

            ZÔºà${elapsedSec
                            }

            sÂàÜÔºâ`);

                        // Ë£úÂ°´Âæå„Å´ÂÆüÁ∏æÂà§ÂÆö
                        try {
                            checkAchievements();
                        }

                        catch (e) {
                            console.error(e)
                        }
                    }
                }

                updateUI();
                if (!silent) notify('„É≠„Éº„ÉâÂÆå‰∫Ü');
            }

            catch (e) {
                console.error(e);
                notify('„É≠„Éº„Éâ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
            }
        }

        function resetGame() {
            const canReincarnate = gameState.money >= 1000000;
            // Bypass confirm for Reincarnation (User request/Testing convenience)
            // Just prompt for Hard Reset
            if (!canReincarnate) {
                if (!confirm('Êú¨ÂΩì„Å´„É™„Çª„ÉÉ„Éà„Åó„Åæ„Åô„ÅãÔºü „Çª„Éº„Éñ„ÅØÊ∂à„Åà„Åæ„Åô„ÄÇ')) return;
            } else {
                // Optional: confirm for Reincarnation? User said "resetGame to PRESERVE...". 
                // Let's keep it smoother.
            }

            let nextPrestige = gameState.prestigeMultiplier || 1.0;
            let nextCount = gameState.reincarnationCount || 0;
            let nextRP = gameState.reincarnationPoints || 0;

            if (canReincarnate) {
                // Formula: +10% per sqrt(1M)
                // e.g. 1M => sqrt(1) * 0.1 = +0.1
                // 4M => sqrt(4) * 0.1 = +0.2
                const bonus = Math.sqrt(gameState.money / 1000000) * 0.1;
                nextPrestige += bonus;
                nextCount += 1;

                const gainedRP = gameState.matrixRedefinition ? 10 : 1;
                nextRP += gainedRP;

                notify(`Ëª¢ÁîüÂÆå‰∫ÜÔºÅ „Éú„Éº„Éä„Çπ +${(bonus * 100).toFixed(1)}% / RP +${gainedRP}`);
            }

            else {
                notify('ÂàùÊúüÂåñ„Åó„Åæ„Åó„Åü');
            }

            // „Éá„Éï„Ç©„É´„ÉàÂÆöÁæ©„Åã„Çâ„Ç≥„Éî„ÉºÔºàÈñ¢Êï∞„Çí‰øùÊåÅÔºâ
            producers = defaultProducers.map(p => ({
                ...p
            }));

            upgrades = defaultUpgrades.map(u => ({
                ...u
            }));

            // Only reset artifacts on HARD RESET -> Now handled by deleteGame. 
            // Here we KEEP artifacts.
            // if (!canReincarnate) ... -> REMOVED persistence check. Always keep.

            upgrades = defaultUpgrades.map(u => ({
                ...u
            }));

            // PERSISTENCE: Artifacts are preserved on Reincarnation AND basic Reset.
            // They are only wiped via "Delete Data" (Hard Reset).
            // So we do NOT map from defaultArtifacts here. We keep the existing `artifacts` array.
            // However, we must ensure that we don't carry over buggy states, but 'bought' status should be kept.
            // If the array is empty (first run logic handled in init), but here `artifacts` exists.

            // Re-apply artifacts logic (in case they have passive effects that need re-triggering)
            // But wait, `gameState` is reset below.

            // Achievements are reset on both Reset and Reincarnation as per request (or maybe we should keep them too? User said 'Basic' too. Let's keep them?)
            // "Enable Skill Tree persistence... " -> specifically skill tree.
            // "Achievements... reset on reincarnation" -> previous request.
            // Let's stick to: Artifacts KP, Achievements Reset.
            achievements = defaultAchievements.map(a => ({
                ...a,
                rewarded: false // Explicitly reset
            }));

            // Persistence for automation settings
            const keepAutoBuy = gameState.autoBuyActive;
            const keepAutoUpgrade = gameState.autoUpgradeActive;
            const keepAutoReincarnate = gameState.autoReincarnateActive;
            const keepThreshold = gameState.autoReincarnateThreshold;
            const keepAutoMani = gameState.autoManipulatorActive;
            const keepManiTarget = gameState.autoManipulatorTarget;
            const keepManiCap = gameState.autoManipulatorCap;

            gameState = {
                money: 0,
                totalZ: 0,
                clickPower: 1,
                globalMultiplier: 1,
                producerMultipliers: {},
                playTimeSec: 0,
                reincarnationCount: nextCount,
                prestigeMultiplier: nextPrestige,
                reincarnationPoints: nextRP,
                autoBuyActive: keepAutoBuy,
                autoUpgradeActive: keepAutoUpgrade,
                autoReincarnateActive: keepAutoReincarnate,
                autoReincarnateThreshold: keepThreshold,
                autoManipulatorActive: keepAutoMani,
                autoManipulatorTarget: keepManiTarget,
                autoManipulatorCap: keepManiCap,
                matrixRedefinition: false, // Reset to false, will be re-applied by artifacts
                lastTick: Date.now()
            };

            // Re-apply artifacts effects to the new GameState
            artifacts.forEach(a => {
                if (a.bought) {
                    const def = defaultArtifacts.find(d => d.id === a.id);
                    if (def && def.apply) def.apply(gameState);
                }
            });

            saveGame(); // Save immediately
            updateUI();
        }

        function deleteGame() {
            if (!confirm('Êú¨ÂΩì„Å´ÂÖ®„Å¶„ÅÆ„Éá„Éº„Çø„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü\nÔºà„Çπ„Ç≠„É´„ÉÑ„É™„Éº„ÇÑËª¢Áîü„Éù„Ç§„É≥„Éà„ÇÇÂÖ®„Å¶Ê∂à„Åà„Åæ„ÅôÔºâ')) return;
            localStorage.removeItem(GAME_SAVE_KEY);
            location.reload();
        }

        /* ----- „É¶„Éº„Ç∂„ÉºÊìç‰ΩúÔºö„ÇØ„É™„ÉÉ„ÇØ„ÅßZ„ÇíÁç≤Âæó ----- */
        const tapEl = document.getElementById('tapGain');

        if (tapEl) {
            tapEl.addEventListener('click', () => {
                gameState.money += gameState.clickPower;
                gameState.totalZ += gameState.clickPower;

                // „ÇØ„É™„ÉÉ„ÇØ„ÅßÂÆüÁ∏æ„ÅåÂ§â„Çè„ÇãÂèØËÉΩÊÄß„Åå„ÅÇ„Çã„Åü„ÇÅ„ÉÅ„Çß„ÉÉ„ÇØ
                try {
                    checkAchievements();
                }

                catch (e) {
                    console.error(e)
                }

                updateUI();
            });
        }

        /* ----- „Çø„ÉñÂàáÊõøÂá¶ÁêÜÔºàÂè≥„Ç´„É©„É†Ôºâ ----- */
        let currentTab = 'mono';
        const tabButtons = document.querySelectorAll('.tab-btn');

        tabButtons.forEach(b => {
            b.addEventListener('click', () => {
                tabButtons.forEach(bb => bb.classList.remove('active'));
                b.classList.add('active');
                currentTab = b.dataset.tab;
                const content = document.getElementById('tabContent');
                content.innerHTML = '';

                if (currentTab === 'mono') {
                    const div = document.createElement('div'); div.id = 'monoPanel';
                    content.appendChild(div);
                    renderMonoPanel();
                }

                else if (currentTab === 'chie') {
                    renderChiePanel();
                }

                else if (currentTab === 'ach') {
                    renderAchPanel();
                }
            });
        });

        /* ----- „Éú„Çø„É≥Ôºà„Çª„Éº„ÉñÁ≠âÔºâ„ÅÆÊé•Á∂ö ----- */
        const saveBtn = document.getElementById('saveBtn');
        if (saveBtn) saveBtn.addEventListener('click', saveGame);
        const loadBtn = document.getElementById('loadBtn');
        if (loadBtn) loadBtn.addEventListener('click', () => loadGame(false));
        const resetBtn = document.getElementById('resetBtn');
        if (resetBtn) resetBtn.addEventListener('click', resetGame);
        const delBtn = document.getElementById('deleteDataBtn');
        if (delBtn) delBtn.addEventListener('click', deleteGame);

        /* ----- Ëá™Âãï„Çª„Éº„ÉñÔºà‰∏ÄÂÆöÈñìÈöîÔºâ ----- */
        setInterval(() => {
            saveGame();
        }

            , 60000);

        /* ----- „É°„Ç§„É≥„É´„Éº„ÉóÔºàrequestAnimationFrameÔºâ ----- */
        let lastTime = performance.now();
        let uiTimer = 0;

        function mainLoop(now) {
            const dtMs = now - lastTime;
            lastTime = now;
            const dt = dtMs / 1000;
            tick(dt);

            uiTimer += dt;

            if (uiTimer >= 1.0) {
                updateUI();
                uiTimer = 0;
            }

            requestAnimationFrame(mainLoop);
        }

        /* ----- CodePen„Å™„Å©„ÅßrAF„ÅåÊ≠¢„Åæ„Å£„ÅüÂ†¥Âêà„ÅÆË£úÂ°´Ôºà„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÔºâ ----- */
        /*
                  rAF „ÅåÂÅúÊ≠¢„Åó„Å¶„ÅÑ„ÇãÔºà/Ê•µÁ´Ø„Å´ÈñìÂºï„Åã„Çå„Å¶„ÅÑ„ÇãÔºâÁí∞Â¢É„Åß„ÅØ tick „ÅåÂëº„Å∞„Çå„ÅöÊîæÁΩÆÂàÜ„ÅåÂ§±„Çè„Çå„Çã„ÄÇ
                  „Åù„Åì„Åß tick „ÅåÊ≠¢„Åæ„Å£„Å¶„ÅÑ„ÇãÊôÇÈñì„Çí _lastTickTime „ÅßÂà§ÂÆö„Åó„ÄÅsetInterval „Åß„Åæ„Å®„ÇÅ„Å¶Ë£úÂ°´„Åô„Çã„ÄÇ
                  - rAF „ÅåÂãï„ÅÑ„Å¶„ÅÑ„ÇãÂ†¥ÂêàÔºàtick„ÅåÊõ¥Êñ∞„Åó„Å¶„ÅÑ„Çã„Å®„ÅçÔºâ„ÅØ‰Ωï„ÇÇ„Åó„Å™„ÅÑÔºà‰∫åÈáçÂä†ÁÆó„ÇíÈò≤Ê≠¢Ôºâ„ÄÇ
                */
        setInterval(() => {
            const now = Date.now();
            const elapsed = (now - _lastTickTime) / 1000;
            // rAF„ÅåÂãï„ÅÑ„Å¶„ÅÑ„Çå„Å∞ elapsed „ÅØÈùûÂ∏∏„Å´Â∞è„Åï„ÅÑ„ÅÆ„Åß‰Ωï„ÇÇ„Åó„Å™„ÅÑ
            if (elapsed < 0.5) return;

            // rAF„ÅåÊ≠¢„Åæ„Å£„Å¶„ÅÑ„ÇãÊôÇÈñì„Å†„Åë„Åæ„Å®„ÇÅ„Å¶Âä†ÁÆó
            const prod = calcProdPerSecond();
            const gain = prod * elapsed;

            if (gain > 0) {
                gameState.money += gain;
                gameState.totalZ += gain;
                gameState.playTimeSec += elapsed;

                try {
                    checkAchievements();
                }

                catch (e) {
                    console.error(e)
                }

                try {
                    updateUI();
                }

                catch (e) {
                    console.error(e)
                }
            }

            _lastTickTime = now;
        }

            , 1000);

        /* ----- ÂàùÊúüÂåñÂá¶ÁêÜÔºàËµ∑ÂãïÊôÇ„Å´‰∏ÄÂ∫¶„Å†„ÅëÂÆüË°åÔºâ ----- */
        (function init() {
            // „Çª„Éº„Éñ„Åå„ÅÇ„Çå„Å∞Ë™≠„ÅøËæº„ÇÄÔºàËµ∑ÂãïÊôÇ„ÅØÈÄöÁü•„ÇíÊéß„Åà„ÇãÔºâ
            loadGame(true);

            // ÂàùÂõûUIÊõ¥Êñ∞
            updateUI();

            // Expose for debugging/testing
            window.gameState = gameState;
            window.updateUI = updateUI;
            window.producers = producers;
            window.artifacts = artifacts;

            // „É°„Ç§„É≥„É´„Éº„ÉóÈñãÂßã
            requestAnimationFrame(mainLoop);
        })();

        /* ----- Ë£úÂä©Ôºö„ÅäÈáë‰∏çË∂≥„ÅÆ„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØÔºàÁü≠ÊôÇÈñìÁÇπÊªÖÔºâ ----- */
        function flashInsufficient() {
            const el = document.getElementById('money');
            if (!el) return;
            el.style.transition = 'none';
            el.style.color = '#ffb4b4';

            setTimeout(() => {
                el.style.transition = 'color 400ms'; el.style.color = '#fff'
            }

                , 220);
        }

    </script>
</body>

</html>
