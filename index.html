<!doctype html>
<html lang="ja">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>„Åµ„Å§„ÅÜ„ÅÆÊîæÁΩÆ„Ç≤„Éº„É†</title>
    <style>
        :root {
            --bg: #0f1724;
            --panel: #0b1220;
            --accent: #7dd3fc;
            --muted: #94a3b8;
            --card: #0e1a2b;
            --glass: rgba(255, 255, 255, 0.03);
            --glass-2: rgba(255, 255, 255, 0.02);
            --radius: 12px;
            font-family: "Noto Sans JP", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
        }

        html,
        body {
            height: 100%;
            margin: 0;
            background: linear-gradient(180deg, #071029 0%, #061727 100%);
            color: #e6eef6
        }

        .container {
            display: grid;
            grid-template-columns: 1fr 2fr 320px;
            gap: 16px;
            height: 100vh;
            padding: 18px;
            box-sizing: border-box;
        }

        /* Left column */
        .left {
            background: linear-gradient(180deg, var(--panel), #061424);
            border-radius: var(--radius);
            padding: 16px;
            box-shadow: 0 6px 18px rgba(2, 6, 23, 0.6);
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .left-top {
            background: var(--glass);
            padding: 14px;
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
        }

        .money {
            display: flex;
            flex-direction: column;
        }

        .money .label {
            font-size: 13px;
            color: var(--muted)
        }

        .money .value {
            font-size: 22px;
            font-weight: 700;
            color: #fff;
            letter-spacing: 0.02em;
        }

        .zps {
            text-align: right;
        }

        .zps .label {
            font-size: 13px;
            color: var(--muted)
        }

        .zps .value {
            font-size: 18px;
            font-weight: 600;
            color: var(--accent)
        }

        .left-middle {
            flex: 1;
            background: var(--glass-2);
            border-radius: 10px;
            padding: 12px;
            overflow: auto;
        }

        /* Center column */
        .center {
            background: linear-gradient(180deg, #07182a, #051223);
            border-radius: var(--radius);
            padding: 18px;
            display: flex;
            flex-direction: column;
            gap: 16px;
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.6);
        }

        .big-action {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 14px;
            flex-wrap: wrap;
        }

        .big-click {
            background: linear-gradient(180deg, #0ea5a0, #046b6b);
            border-radius: 18px;
            padding: 22px 28px;
            font-size: 20px;
            font-weight: 700;
            cursor: pointer;
            user-select: none;
            box-shadow: 0 8px 30px rgba(4, 139, 139, 0.18), inset 0 -4px 12px rgba(255, 255, 255, 0.03);
        }

        .mini-info {
            background: var(--glass);
            padding: 12px 16px;
            border-radius: 12px;
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .center-bottom {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
        }

        .card {
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.02), rgba(255, 255, 255, 0.01));
            padding: 12px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.03);
        }

        /* Artifact Tree */
        .artifact-panel {
            background: var(--card);
            border-radius: 12px;
            padding: 16px;
            position: relative;
            min-height: 300px;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .artifact-tree-svg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
        }

        .artifact-node {
            position: absolute;
            transform: translate(-50%, -50%);
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: linear-gradient(180deg, #1f2937, #111827);
            border: 2px solid #374151;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 20px;
            cursor: pointer;
            z-index: 1;
            transition: all 0.2s;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .artifact-node:hover {
            transform: translate(-50%, -50%) scale(1.1);
            border-color: var(--accent);
            z-index: 10;
        }

        .artifact-node.bought {
            background: linear-gradient(180deg, #0ea5e9, #0284c7);
            border-color: #7dd3fc;
            box-shadow: 0 0 15px rgba(14, 165, 233, 0.4);
        }

        .artifact-node.locked {
            opacity: 0.5;
            cursor: not-allowed;
            filter: grayscale(1);
        }

        .artifact-node.available {
            border-color: #fbbf24;
            animation: pulse-border 2s infinite;
        }

        @keyframes pulse-border {
            0% {
                box-shadow: 0 0 0 0 rgba(251, 191, 36, 0.4);
            }

            70% {
                box-shadow: 0 0 0 6px rgba(251, 191, 36, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(251, 191, 36, 0);
            }
        }

        .artifact-tooltip {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 12px;
            pointer-events: none;
            white-space: nowrap;
            z-index: 20;
            border: 1px solid rgba(255, 255, 255, 0.1);
            display: none;
        }

        /* Right column (tabbed area) */
        .right {
            background: linear-gradient(180deg, #071826, #04121a);
            border-radius: var(--radius);
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            box-shadow: 0 8px 22px rgba(2, 6, 23, 0.6);
        }

        .tabs {
            display: flex;
            gap: 10px;
        }

        .tab-btn {
            flex: 1;
            padding: 10px 12px;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            user-select: none;
            background: transparent;
            color: var(--muted);
            border: 1px solid transparent;
            font-weight: 700;
        }

        .tab-btn.active {
            background: linear-gradient(180deg, rgba(125, 211, 252, 0.12), rgba(125, 211, 252, 0.06));
            color: var(--accent);
            border: 1px solid rgba(125, 211, 252, 0.12);
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.45);
        }

        .tab-content {
            background: var(--card);
            border-radius: 10px;
            padding: 12px;
            flex: 1;
            overflow: auto;
        }

        /* Producer list */
        .producer {
            display: flex;
            justify-content: space-between;
            gap: 10px;
            align-items: center;
            padding: 8px;
            border-radius: 8px;
            margin-bottom: 8px;
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.01), rgba(255, 255, 255, 0.00));
            border: 1px solid rgba(255, 255, 255, 0.02);
        }

        .producer .left {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .producer .name {
            font-weight: 700
        }

        .producer .meta {
            font-size: 12px;
            color: var(--muted)
        }

        .buy-btn {
            padding: 8px 10px;
            border-radius: 8px;
            cursor: pointer;
            background: linear-gradient(180deg, #1f2937, #0f1724);
            color: #e6eef6;
            border: 1px solid rgba(255, 255, 255, 0.03);
            font-weight: 700;
        }

        .buy-btn:disabled {
            opacity: 0.45;
            cursor: not-allowed
        }

        /* Upgrades */
        .upgrade {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            padding: 8px;
            border-radius: 8px;
            margin-bottom: 8px;
            border: 1px solid rgba(255, 255, 255, 0.02);
        }

        /* Achievements */
        .ach {
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 8px;
            background: rgba(255, 255, 255, 0.01);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }

        .ach.locked {
            opacity: 0.5
        }

        /* footer small */
        .small {
            font-size: 12px;
            color: var(--muted);
            text-align: center;
            padding: 6px;
        }

        /* responsive */
        @media(max-width:900px) {
            .container {
                grid-template-columns: 1fr;
                grid-auto-rows: min-content;
                padding: 12px;
                gap: 12px;
            }

            .right {
                order: 3
            }

            .left {
                order: 1
            }

            .center {
                order: 2
            }
        }



        /* Toggle Switch */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 36px;
            height: 20px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #334155;
            transition: .4s;
            border-radius: 20px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked+.slider {
            background-color: var(--accent);
        }

        input:checked+.slider:before {
            transform: translateX(16px);
        }
    </style>
</head>

<body>
    <div class="container"><!-- LEFT -->
        <div class="left" id="leftPanel">
            <div class="left-top">
                <div class="money">
                    <div class="label">ÊâÄÊåÅZ</div>
                    <div class="value" id="money">0</div>
                </div>
                <div class="zps">
                    <div class="label">1Áßí„ÅÇ„Åü„Çä„ÅÆÁîüÁî£</div>
                    <div class="value" id="zps">0 Z/s</div>
                </div>
            </div>
            <div class="left-middle" id="leftMiddle">
                <h3 style="margin:6px 0 10px 0">Áµ±Ë®à / „Çª„Éº„Éñ</h3>
                <div class="card" style="margin-bottom:8px">
                    <div>Á∑èÁç≤ÂæóZ: <span id="totalZ">0</span></div>
                    <div>„Éó„É¨„Ç§ÊôÇÈñì: <span id="playTime">0s</span></div>
                    <div style="margin-top:4px; border-top:1px solid rgba(255,255,255,0.1); padding-top:4px">
                        <div style="font-size:12px;color:var(--muted)">Ëª¢ÁîüÂõûÊï∞: <span id="reincarnationCount">0</span>
                        </div>
                        <div style="font-size:12px;color:var(--muted)">Ëª¢Áîü„Éú„Éº„Éä„Çπ: <span id="prestigeMult">x1.00</span>
                        </div>
                    </div>
                </div>
                <div class="card"><button id="saveBtn" class="buy-btn"
                        style="width:100%;margin-bottom:8px">„Çª„Éº„Éñ</button><button id="loadBtn" class="buy-btn"
                        style="width:100%;margin-bottom:8px">„É≠„Éº„Éâ</button><button id="resetBtn" class="buy-btn"
                        style="width:100%;background:#7f1d1d;border-color:#7f1d1d">„É™„Çª„ÉÉ„Éà</button></div>
                <div class="card" id="automationPanel" style="display:none; margin-top:8px">
                    <div style="display:flex; justify-content:space-between; align-items:center">
                        <div style="font-size:13px; color:var(--accent)">Ëá™ÂãïË≥ºÂÖ•</div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="autoBuyToggle" checked>
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
            </div>
        </div><!-- CENTER -->
        <div class="center">
            <div class="big-action">
                <div class="big-click" id="tapGain">„ÇØ„É™„ÉÉ„ÇØ„ÅßZ„ÇíÂæó„Çã</div>
                <div class="mini-info card">
                    <div>
                        <div style="font-size:12px; color:var(--muted)">„ÇØ„É™„ÉÉ„ÇØ„ÅßÂæó„Çâ„Çå„ÇãZ</div>
                        <div style="font-weight:700; font-size:16px" id="clickValue">1</div>
                    </div>
                    <div style="margin-left:auto;text-align:right">
                        <div style="font-size:12px;color:var(--muted)">Ê¨°„ÅÆÊùë‰∫∫‰æ°Ê†º</div>
                        <div style="font-weight:700" id="nextVillagerCost">--</div>
                    </div>
                </div>
            </div><!-- Artifact Tree Section -->
            <div class="artifact-panel" id="artifactPanel">
                <h4 style="margin:0 0 12px 0; text-align:center; color:var(--muted)">„Ç¢„Éº„ÉÜ„Ç£„Éï„Ç°„ÇØ„Éà</h4><svg
                    class="artifact-tree-svg" id="treeSvg"></svg>
                <div id="treeNodes"></div>
                <div class="artifact-tooltip" id="artifactTooltip"></div>
            </div>
        </div><!-- RIGHT -->
        <div class="right">
            <div class="tabs">
                <div class="tab-btn active" data-tab="mono" id="tabMono">„É¢„Éé</div>
                <div class="tab-btn" data-tab="chie" id="tabChie">Áü•ÊÅµ</div>
                <div class="tab-btn" data-tab="ach" id="tabAch">ÂÆüÁ∏æ</div>
            </div>
            <div class="tab-content" id="tabContent"><!-- default: „É¢„Éé -->
                <div id="monoPanel"></div>
            </div>
            <div style="display:flex;gap:8px">
                <div style="flex:1" class="small">„Éê„Éº„Ç∏„Éß„É≥: 1.01 ¬∑ ‰øùÂ≠ò„ÅØ„Éñ„É©„Ç¶„Ç∂„Å´‰øùÊåÅ</div>
            </div>
        </div>
    </div>
    <script>
        /*
                  Êó•Êú¨Ë™û„Ç≥„É°„É≥„Éà‰ªò„Åç JavaScriptÔºà‰øÆÊ≠£Áâà„ÉªÂÆåÂÖ®ÁâàÔºâ
                  ‚Äª Ê©üËÉΩ„ÅØÂÖÉ„ÅÆ„Åæ„Åæ„ÄÅ„Éê„Ç∞‰øÆÊ≠£„Å®ÊúÄÂ∞è„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ„ÅÆ„Åø„ÇíËøΩÂä†„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇ
                */

        /* ----- ÂÆöÊï∞„Å®ÂàùÊúü„Éá„Éº„Çø ----- */
        const GAME_SAVE_KEY = "idle_z_save_v1";

        const defaultProducers = [{
            id: 'villager', name: 'Êùë‰∫∫', baseCost: 10, costMult: 1.15, baseProd: 0.5, count: 0, icon: 'üë®‚Äçüåæ'
        }

            ,
        {
            id: 'farmer', name: 'Ëæ≤Â§´', baseCost: 120, costMult: 1.15, baseProd: 6, count: 0, icon: 'üåæ'
        }

            ,
        {
            id: 'miner', name: 'Êé°ÊéòËÄÖ', baseCost: 1500, costMult: 1.15, baseProd: 80, count: 0, icon: '‚õèÔ∏è'
        }

            ,
        {
            id: 'factory', name: 'Â∑•Â†¥', baseCost: 20000, costMult: 1.17, baseProd: 1200, count: 0, icon: 'üè≠'
        }

        ];

        const defaultUpgrades = [{

            id: 'clickBoost',
            name: '„ÇØ„É™„ÉÉ„ÇØÂäπÁéá +2',
            desc: '„ÇØ„É™„ÉÉ„ÇØ„ÅßÂæó„ÇãZ„ÅåÂ¢ó„Åà„Çã',
            cost: 50,
            bought: false,
            apply: (g) => {
                g.clickPower += 2
            }
        }

            ,
        {

            id: 'prodBoost1',
            name: 'ÁîüÁî£ÂäπÁéá +25%',
            desc: 'ÂÖ®„É¶„Éã„ÉÉ„Éà„ÅÆÁîüÁî£„Åå+25%',
            cost: 1000,
            bought: false,
            apply: (g) => {
                g.globalMultiplier *= 1.25
            }
        }

            ,
        {

            id: 'prodBoost2',
            name: 'ÁîüÁî£ÂäπÁéá +100%',
            desc: 'ÂÖ®„É¶„Éã„ÉÉ„Éà„ÅÆÁîüÁî£„Åå+100%',
            cost: 20000,
            bought: false,
            apply: (g) => {
                g.globalMultiplier *= 2
            }
        }

            ,
        {

            id: 'intensiveFarming',
            name: 'ÈõÜÁ¥ÑÁöÑËæ≤Ê•≠',
            desc: 'Êùë‰∫∫„Å®Ëæ≤Â§´„ÅÆÁîüÁî£„Åå+500%',
            cost: 5000,
            bought: false,
            apply: (g) => {
                if (!g.producerMultipliers) g.producerMultipliers = {}

                    ;
                g.producerMultipliers['villager'] = (g.producerMultipliers['villager'] || 1) * 6;
                g.producerMultipliers['farmer'] = (g.producerMultipliers['farmer'] || 1) * 6;
            }
        }

        ];

        const defaultArtifacts = [{

            id: 'art_tablet',
            name: 'Âè§‰ª£„ÅÆÁü≥Êùø',
            desc: 'ÁîüÁî£ÂäπÁéá +10000%',
            cost: 100,
            x: 50,
            y: 20,
            parent: null,
            icon: 'üìú',
            apply: (g) => {
                g.globalMultiplier *= 101;
            }
        }

            ,
        {

            id: 'art_stone',
            name: 'Áü≥„ÅÆÈÅìÂÖ∑',
            desc: '„ÇØ„É™„ÉÉ„ÇØ +500',
            cost: 500,
            x: 30,
            y: 50,
            parent: 'art_tablet',
            icon: 'ü™®',
            apply: (g) => {
                g.clickPower += 500;
            }
        }

            ,
        {

            id: 'art_irrig',
            name: 'ÁÅåÊºë',
            desc: 'Ëæ≤Â§´„ÅÆÁîüÁî£ +5000%',
            cost: 1000,
            x: 70,
            y: 50,
            parent: 'art_tablet',
            icon: 'üíß',
            apply: (g) => {
                if (!g.producerMultipliers) g.producerMultipliers = {}

                    ;
                g.producerMultipliers['farmer'] = (g.producerMultipliers['farmer'] || 1) * 51;
            }
        }

            ,
        {

            id: 'art_iron',
            name: 'ÈâÑ„ÅÆÈÅìÂÖ∑',
            desc: '„ÇØ„É™„ÉÉ„ÇØ +1000',
            cost: 2000,
            x: 20,
            y: 80,
            parent: 'art_stone',
            icon: '‚öîÔ∏è',
            apply: (g) => {
                g.clickPower += 1000;
            }
        }

            ,
        {
            id: 'art_coop',
            name: 'Ëæ≤Ê•≠ÂçîÂêåÁµÑÂêà',
            desc: 'Êùë‰∫∫„ÅÆ„Ç≥„Çπ„Éà„Åå„ÇÅ„Å£„Å°„ÇÉÊ∏õ„Çã',
            cost: 25000,
            x: 80,
            y: 20,
            parent: 'art_tablet',
            icon: 'ü§ù',
            apply: (g) => {
                const v = producers.find(p => p.id === 'villager');
                if (v) v.baseCost = v.baseCost * 0.00000000000001;
            }
        }

            ,
        {

            id: 'art_crop',
            name: 'Ëº™‰Ωú',
            desc: 'Ëæ≤Â§´„ÅÆÁîüÁî£ +10000%',
            cost: 5000,
            x: 80,
            y: 80,
            parent: 'art_irrig',
            icon: 'üîÑ',
            apply: (g) => {
                if (!g.producerMultipliers) g.producerMultipliers = {}

                    ;
                g.producerMultipliers['farmer'] = (g.producerMultipliers['farmer'] || 1) * 101;
            }
        },
        {
            id: 'art_manager',
            name: '„Åó„Çì„Åé„ÇÖ„Çâ„Çä„Å¶„ÅÉÔºü',
            desc: 'ÊúÄ„ÇÇÁîüÁî£„ÅåÈ´ò„ÅÑË®≠ÂÇô„ÇíËá™Âãï„ÅßË≥ºÂÖ• ',
            cost: 50000,
            x: 50,
            y: 80,
            parent: 'art_iron',
            icon: '‚öôÔ∏è',
            apply: (g) => {
                g.autoBuy = true;
            }
        },
        {
            id: 'haguruma',
            name: 'Ê≠ØËªä',
            desc: 'Â∑•Â†¥„ÅÆÁîüÁî£„Åå10000ÂÄç',
            cost: 50000000,
            x: 50,
            y: 50,
            parent: 'art_manager',
            icon: '‚öôÔ∏è',
            apply: (g) => {
                if (!g.producerMultipliers) g.producerMultipliers = {}

                    ;
                g.producerMultipliers['factory'] = (g.producerMultipliers['factory'] || 1) * 10001;
            }
        }
        ];

        const defaultAchievements = [{

            id: 'firstZ',
            name: 'ÊúÄÂàù„ÅÆ10Z',
            desc: 'Z„Çí10Áç≤Âæó',
            condition: gs => gs.totalZ >= 10,
            rewarded: false,
            reward: gs => {
                gs.money += 20
            }
        }

            ,
        {

            id: 'hundredZ',
            name: 'Z„Çí100Áç≤Âæó',
            desc: 'Z„Çí100Áç≤Âæó',
            condition: gs => gs.totalZ >= 100,
            rewarded: false,
            reward: gs => {
                gs.globalMultiplier *= 1.10
            }
        }

            ,
        {

            id: 'hireOne',
            name: 'Êùë‰∫∫„ÇíÈõá„ÅÜ',
            desc: 'Êùë‰∫∫„Çí1‰∫∫Èõá„ÅÜ',
            condition: gs => producers.find(p => p.id === 'villager').count >= 1,
            rewarded: false,
            reward: gs => {
                gs.money += 5
            }
        },
        {

            id: 'hireOne',
            name: 'Lv999„ÅÆÊùë‰∫∫',
            desc: '???',
            condition: gs => producers.find(p => p.id === 'villager').count >= 999,
            rewarded: false,
            reward: gs => {
                apply: (g) => {
                    if (!g.producerMultipliers) g.producerMultipliers = {}

                        ;
                    g.producerMultipliers['villager'] = (g.producerMultipliers['villager'] || 1) * 999999;
                }
            }
        }

        ];

        /* ----- „Ç≤„Éº„É†Áä∂ÊÖãÔºàÂèØÂ§âÔºâ ----- */

        // Èñ¢Êï∞„Çí‰øù„Å£„Åü„Åæ„Åæ„Ç≥„Éî„Éº„Åô„ÇãÔºàJSONÁ≥ª„ÅØÈñ¢Êï∞„ÇíÊ∂à„Åô„ÅÆ„Åß‰Ωø„Çè„Å™„ÅÑÔºâ
        let producers = defaultProducers.map(p => ({
            ...p
        }));

        let upgrades = defaultUpgrades.map(u => ({
            ...u
        }));

        let artifacts = defaultArtifacts.map(a => ({
            ...a, bought: false
        }));

        let achievements = defaultAchievements.map(a => ({
            ...a
        }));

        let gameState = {

            money: 0,
            totalZ: 0,
            clickPower: 1,
            globalMultiplier: 1,
            producerMultipliers: {}

            ,
            playTimeSec: 0,
            reincarnationCount: 0,
            prestigeMultiplier: 1.0,
            autoBuyActive: true,
            lastTick: Date.now()
        }

            ;

        /* ----- „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÁî®„Çø„Ç§„É†„Çπ„Çø„É≥„ÉóÔºàrAF„ÅåÊ≠¢„Åæ„Å£„Åü„ÅãÂà§ÂÆö„Åô„Çã„Åü„ÇÅÔºâ ----- */
        let _lastTickTime = Date.now();

        /* ----- „É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£Èñ¢Êï∞ ----- */
        function formatNum(n) {
            if (!isFinite(n)) return '0';
            if (n >= 1e15) return n.toExponential(2);
            if (n >= 1e12) return (n / 1e12).toFixed(2) + 'T';
            if (n >= 1e9) return (n / 1e9).toFixed(2) + 'B';
            if (n >= 1e6) return (n / 1e6).toFixed(2) + 'M';
            if (n >= 1000) return (n / 1000).toFixed(2) + 'k';
            if (Math.abs(n - Math.round(n)) < 1e-9) return String(Math.round(n));
            return Number(n.toFixed(2)).toString();
        }

        function calcProdPerSecond() {
            let sum = 0;

            for (const p of producers) {
                let mult = 1;

                if (gameState.producerMultipliers && gameState.producerMultipliers[p.id]) {
                    mult = gameState.producerMultipliers[p.id];
                }

                sum += (p.count || 0) * p.baseProd * mult;
            }

            sum *= gameState.globalMultiplier;
            sum *= (gameState.prestigeMultiplier || 1);
            return sum;
        }

        function nextCost(p) {
            return Math.floor(p.baseCost * Math.pow(p.costMult, p.count));
        }

        function calcMaxAffordable(p, money) {
            if (money < nextCost(p)) return 0;
            const r = p.costMult;
            const a = nextCost(p);
            // Sum = a * (r^n - 1) / (r - 1) <= money
            // r^n <= money * (r - 1) / a + 1
            // n <= log_r( ... )
            const n = Math.floor(Math.log(money * (r - 1) / a + 1) / Math.log(r));
            return n;
        }

        function buyProducerMax(id) {
            const p = producers.find(x => x.id === id);
            if (!p) return;
            const max = calcMaxAffordable(p, gameState.money);
            if (max <= 0) {
                flashInsufficient();
                return;
            }

            // Loop to buy one by one to trigger bonuses properly
            // (Optimization: In a real heavy game, we would calculate sums, but for this scale, a loop is fine)
            // Actually, let's just do it in a loop to ensure all "every 10th" logic fires correctly.
            // However, for "Max" which could be 100s, let's cap it or ensure it's performant? 
            // Javascript loop of 1000 is instant.
            for (let i = 0; i < max; i++) {
                const cost = nextCost(p);
                if (gameState.money < cost) break; // Should not happen if calculation is correct
                gameState.money -= cost;
                p.count += 1;
                if (p.count % 10 === 0) {
                    gameState.money += Math.floor(p.baseProd * 5 * gameState.globalMultiplier);
                }
            }

            try {
                checkAchievements();
            } catch (e) {
                console.error(e);
            }
            updateUI();
        }

        /* ----- UI Êõ¥Êñ∞Âá¶ÁêÜÔºàË°®Á§∫„ÇíÊúÄÊñ∞ÂåñÔºâ ----- */
        function updateUI() {
            const elMoney = document.getElementById('money');
            if (elMoney) elMoney.textContent = formatNum(gameState.money);
            const elZps = document.getElementById('zps');
            if (elZps) elZps.textContent = formatNum(calcProdPerSecond()) + ' Z/s';
            const elTotal = document.getElementById('totalZ');
            if (elTotal) elTotal.textContent = formatNum(gameState.totalZ);
            const elPlay = document.getElementById('playTime');
            if (elPlay) elPlay.textContent = Math.floor(gameState.playTimeSec) + 's';
            const elClick = document.getElementById('clickValue');
            if (elClick) elClick.textContent = formatNum(gameState.clickPower) + ' Z';
            const vill = producers.find(p => p.id === 'villager');
            const elNextVill = document.getElementById('nextVillagerCost');
            if (elNextVill) elNextVill.textContent = vill ? formatNum(nextCost(vill)) : '--';

            const elRein = document.getElementById('reincarnationCount');
            if (elRein) elRein.textContent = gameState.reincarnationCount || 0;
            const elPrestige = document.getElementById('prestigeMult');
            if (elPrestige) elPrestige.textContent = 'x' + (gameState.prestigeMultiplier || 1).toFixed(2);

            // Auto Buy Toggle
            const autoPanel = document.getElementById('automationPanel');
            const autoToggle = document.getElementById('autoBuyToggle');

            if (autoPanel && autoToggle) {
                if (gameState.autoBuy) {
                    autoPanel.style.display = 'block';

                    if (!autoToggle._init) {
                        autoToggle.addEventListener('change', (e) => {
                            gameState.autoBuyActive = e.target.checked;
                        });
                        autoToggle._init = true;
                    }

                    // Sync UI to state (allow user to toggle freely, but ensure state is respected)
                    if (autoToggle.checked !== !!gameState.autoBuyActive) {
                        autoToggle.checked = !!gameState.autoBuyActive;
                    }

                } else {
                    autoPanel.style.display = 'none';
                }
            }

            // Reset Button Text
            const resetBtn = document.getElementById('resetBtn');

            if (resetBtn) {
                if (gameState.money >= 1000000) {
                    resetBtn.textContent = 'Ëª¢Áîü„Åô„Çã';
                    resetBtn.style.background = 'linear-gradient(180deg, #f59e0b, #d97706)';
                    resetBtn.style.borderColor = '#f59e0b';
                }

                else {
                    resetBtn.textContent = '„É™„Çª„ÉÉ„Éà';
                    resetBtn.style.background = '#7f1d1d';
                    resetBtn.style.borderColor = '#7f1d1d';
                }
            }

            renderMonoPanel();
            renderChiePanel();
            renderAchPanel();
            renderArtifactTree();
        }

        /* ----- „É°„Ç§„É≥Âá¶ÁêÜÔºöÊôÇÈñìÁµåÈÅé„Å®ÁîüÁî£Ôºà„Ç≤„Éº„É†„É´„Éº„ÉóÔºâ ----- */
        function tick(dt) {
            // rAF„ÅåÊ≠£Â∏∏„Å´Âãï„ÅÑ„Å¶„ÅÑ„Çã„Åì„Å®„ÇíÁ§∫„Åô„Çø„Ç§„É†„Çπ„Çø„É≥„ÉóÊõ¥Êñ∞
            _lastTickTime = Date.now();

            const prod = calcProdPerSecond();
            const gain = prod * dt;

            gameState.money += gain;
            gameState.totalZ += gain;
            gameState.playTimeSec += dt;

            // Auto Buy Logic
            // Auto Buy Logic
            if (gameState.autoBuy && gameState.autoBuyActive) {
                // Prioritize highest tier affordable
                for (let i = producers.length - 1; i >= 0; i--) {
                    const p = producers[i];
                    if (gameState.money >= nextCost(p)) {
                        buyProducer(p.id);
                        break; // Buy only one per tick to respect priority
                    }
                }
            }

            checkAchievements();
        }

        /* ----- „É¢„ÉéÔºà„Éó„É≠„Éá„É•„Éº„ÇµÔºâ„Éë„Éç„É´„ÅÆÊèèÁîª„Å®Ë≥ºÂÖ•Âá¶ÁêÜ ----- */
        function renderMonoPanel() {
            const container = document.getElementById('monoPanel');
            if (!container) return;
            container.innerHTML = '';

            for (const p of producers) {
                const el = document.createElement('div');
                el.className = 'producer';

                const maxBuy = calcMaxAffordable(p, gameState.money);

                el.innerHTML = ` <div class="left"><div style="font-size:20px">${p.icon
                    }

        </div><div><div class="name">${p.name
                    }

        <span style="font-size:12px;color:var(--muted)">x${p.count
                    }

        </span></div><div class="meta">ÁîüÁî£: ${formatNum(p.baseProd)
                    }

        Z/s</div></div></div><div style="text-align:right"><div style="font-size:13px;color:var(--muted)">‰æ°Ê†º</div><div style="font-weight:700">${formatNum(nextCost(p))
                    }

        Z</div><div style="margin-top:8px; display:flex; gap:4px; justify-content:flex-end">
            <button class="buy-btn" data-id="${p.id}"${gameState.money < nextCost(p) ? 'disabled' : ''
                    }>Ë≥ºÂÖ•</button>
            <button class="buy-btn" data-id-max="${p.id}"${maxBuy <= 0 ? 'disabled' : ''
                    }>Max (+${maxBuy})</button>
        </div></div>`;
                container.appendChild(el);
            }

            container.querySelectorAll('button[data-id]').forEach(b => {
                b.onclick = () => {
                    const id = b.getAttribute('data-id');
                    buyProducer(id);
                }
            });

            container.querySelectorAll('button[data-id-max]').forEach(b => {
                b.onclick = () => {
                    const id = b.getAttribute('data-id-max');
                    buyProducerMax(id);
                }
            });
        }

        function buyProducer(id) {
            const p = producers.find(x => x.id === id);
            if (!p) return;
            const cost = nextCost(p);

            if (gameState.money >= cost) {
                gameState.money -= cost;
                p.count += 1;

                if (p.count % 10 === 0) {
                    gameState.money += Math.floor(p.baseProd * 5 * gameState.globalMultiplier);
                }

                // ÂÆüÁ∏æÂà§ÂÆö„ÇíÁ¢∫ÂÆü„Å´Ë°å„ÅÜÔºàË≥ºÂÖ•„ÅßÈÅîÊàê„Åô„ÇãÂèØËÉΩÊÄß„Åå„ÅÇ„Çã„Åü„ÇÅÔºâ
                try {
                    checkAchievements();
                }

                catch (e) {
                    console.error(e);
                }

                updateUI();

            }

            else {
                flashInsufficient();
            }
        }

        /* ----- „Ç¢„ÉÉ„Éó„Ç∞„É¨„Éº„ÉâÔºàÁü•ÊÅµÔºâ ----- */
        function renderChiePanel() {
            const container = document.getElementById('tabContent');
            if (!container) return;
            if (currentTab !== 'chie') return;

            const panel = document.createElement('div');
            panel.id = 'chiePanel';

            if (upgrades.length === 0) {
                panel.textContent = '„Ç¢„ÉÉ„Éó„Ç∞„É¨„Éº„Éâ„ÅØ„Åæ„Å†„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ';
            }

            else {
                for (const u of upgrades) {
                    const d = document.createElement('div');
                    d.className = 'upgrade';

                    d.innerHTML = ` <div><div style="font-weight:700">${u.name
                        }

            ${u.bought ? 'ÔºàË≥ºÂÖ•Ê∏àÔºâ' : ''
                        }

            </div><div style="font-size:13px;color:var(--muted)">${u.desc
                        }

            </div></div><div style="text-align:right"><div style="font-size:13px;color:var(--muted)">‰æ°Ê†º</div><div style="font-weight:700">${formatNum(u.cost)
                        }

            Z</div><div style="margin-top:8px"><button class="buy-btn" data-upg="${u.id}"${u.bought || gameState.money < u.cost ? 'disabled' : ''
                        }

            >Ë≥ºÂÖ•</button></div></div>`;
                    panel.appendChild(d);
                }
            }

            container.innerHTML = '';
            container.appendChild(panel);

            container.querySelectorAll('.buy-btn').forEach(b => {
                b.onclick = () => {
                    const id = b.getAttribute('data-upg');
                    buyUpgrade(id);
                }
            });
        }

        function buyUpgrade(id) {
            const u = upgrades.find(x => x.id === id);
            if (!u || u.bought) return;

            if (gameState.money >= u.cost) {
                gameState.money -= u.cost;
                u.bought = true;

                try {
                    u.apply(gameState);
                }

                catch (e) {
                    console.error(e)
                }

                // ÂÆüÁ∏æÂà§ÂÆöÔºà„Ç¢„ÉÉ„Éó„Ç∞„É¨„Éº„Éâ„ÅßÊù°‰ª∂„ÅåÊ∫Ä„Åü„Åï„Çå„ÇãÂ†¥Âêà„Åå„ÅÇ„ÇãÔºâ
                try {
                    checkAchievements();
                }

                catch (e) {
                    console.error(e)
                }

                updateUI();
            }

            else flashInsufficient();
        }

        /* ----- „Ç¢„Éº„ÉÜ„Ç£„Éï„Ç°„ÇØ„ÉàÔºà„Çπ„Ç≠„É´„ÉÑ„É™„ÉºÔºâ ----- */
        function renderArtifactTree() {
            const svg = document.getElementById('treeSvg');
            const nodesContainer = document.getElementById('treeNodes');
            const tooltip = document.getElementById('artifactTooltip');
            if (!svg || !nodesContainer) return;

            // Clear previous
            svg.innerHTML = '';
            nodesContainer.innerHTML = '';

            // Draw connections
            defaultArtifacts.forEach(art => {
                if (art.parent) {
                    const parent = defaultArtifacts.find(p => p.id === art.parent);

                    if (parent) {
                        const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                        line.setAttribute('x1', parent.x + '%');
                        line.setAttribute('y1', parent.y + '%');
                        line.setAttribute('x2', art.x + '%');
                        line.setAttribute('y2', art.y + '%');

                        // Line color based on state
                        const artState = artifacts.find(a => a.id === art.id);
                        const parentState = artifacts.find(a => a.id === parent.id);
                        const isUnlocked = parentState && parentState.bought;
                        const isBought = artState && artState.bought;

                        line.setAttribute('stroke', isBought ? '#0ea5e9' : (isUnlocked ? '#4b5563' : '#1f2937'));
                        line.setAttribute('stroke-width', '2');
                        svg.appendChild(line);
                    }
                }
            });

            // Draw nodes
            artifacts.forEach(art => {
                const def = defaultArtifacts.find(d => d.id === art.id);
                const el = document.createElement('div');
                el.className = 'artifact-node';
                el.style.left = def.x + '%';
                el.style.top = def.y + '%';
                el.textContent = def.icon;

                // Determine state
                let isLocked = false;

                if (def.parent) {
                    const parent = artifacts.find(p => p.id === def.parent);
                    if (!parent || !parent.bought) isLocked = true;
                }

                if (art.bought) {
                    el.classList.add('bought');
                }

                else if (isLocked) {
                    el.classList.add('locked');
                }

                else {
                    el.classList.add('available');
                }

                // Interaction
                el.onclick = () => buyArtifact(art.id);

                // Tooltip
                el.onmouseenter = () => {
                    tooltip.style.display = 'block';

                    tooltip.innerHTML = ` <div style="font-weight:700;color:${art.bought ? '#7dd3fc' : '#fff'}" >${def.name
                        }

                </div> <div style="color:#ccc" >${def.desc
                        }

                </div> ${!art.bought ? `<div style="margin-top:4px;font-weight:700;color:${isLocked ? '#ef4444' : '#fbbf24'}" >Cost: ${def.cost
                            }

                    Z</div>` : ''
                        }

                `;
                }

                    ;

                el.onmouseleave = () => {
                    tooltip.style.display = 'none';
                }

                    ;

                nodesContainer.appendChild(el);
            });
        }

        function buyArtifact(id) {
            const art = artifacts.find(a => a.id === id);
            const def = defaultArtifacts.find(d => d.id === id);
            if (!art || !def || art.bought) return;

            // Check parent
            if (def.parent) {
                const parent = artifacts.find(p => p.id === def.parent);

                if (!parent || !parent.bought) {
                    notify('Ë¶™„Ç¢„Éº„ÉÜ„Ç£„Éï„Ç°„ÇØ„Éà„ÅåÂøÖË¶Å„Åß„Åô');
                    return;
                }
            }

            if (gameState.money >= def.cost) {
                gameState.money -= def.cost;
                art.bought = true;

                try {
                    def.apply(gameState);
                }

                catch (e) {
                    console.error(e);
                }

                notify(`„Ç¢„Éº„ÉÜ„Ç£„Éï„Ç°„ÇØ„ÉàÁç≤Âæó: ${def.name
                    }

            `);
                updateUI();
            }

            else {
                flashInsufficient();
            }
        }

        function renderAchPanel() {
            const container = document.getElementById('tabContent');
            if (!container) return;
            if (currentTab !== 'ach') return;

            const panel = document.createElement('div');
            panel.id = 'achPanel';

            for (const a of achievements) {
                const d = document.createElement('div');
                d.className = 'ach ' + (a.rewarded ? 'unlocked' : 'locked');

                d.innerHTML = ` <div><div style="font-weight:700">${a.name
                    }

        </div><div style="font-size:13px;color:var(--muted)">${a.desc
                    }

        </div></div><div style="text-align:right"><div style="font-size:13px;color:${a.rewarded ? '#a6f3c5' : 'var(--muted)'}">${a.rewarded ? 'Áç≤ÂæóÊ∏à' : 'Êú™ÈÅîÊàê'
                    }

        </div></div>`;
                panel.appendChild(d);
            }

            container.innerHTML = '';
            container.appendChild(panel);
        }

        function checkAchievements() {
            let updated = false;

            for (const a of achievements) {
                try {
                    if (!a.rewarded && a.condition(gameState)) {
                        a.rewarded = true;

                        try {
                            a.reward(gameState);
                        }

                        catch (e) {
                            console.error(e)
                        }

                        updated = true;

                        notify(`ÂÆüÁ∏æËß£Èô§: ${a.name
                            }

                    `);
                    }
                }

                catch (e) {
                    console.error('ÂÆüÁ∏æÂà§ÂÆö„Ç®„É©„Éº', a.id, e);
                }
            }

            if (updated) updateUI();
        }

        /* ----- ÈÄöÁü• ----- */
        function notify(msg) {
            const n = document.createElement('div');
            n.textContent = msg;
            n.style.position = 'fixed';
            n.style.right = '20px';
            n.style.bottom = '20px';
            n.style.padding = '12px 18px';
            n.style.borderRadius = '8px';
            n.style.background = 'linear-gradient(180deg, rgba(125,211,252,0.15), rgba(125,211,252,0.08))';
            n.style.color = 'var(--accent)';
            n.style.boxShadow = '0 8px 24px rgba(0,0,0,0.5)';
            n.style.fontSize = '15px';
            n.style.fontWeight = '700';
            n.style.zIndex = '9999';
            document.body.appendChild(n);

            setTimeout(() => {
                n.style.transition = 'all 360ms ease'; n.style.opacity = '0'; n.style.transform = 'translateY(20px)';
            }

                , 2000);
            setTimeout(() => n.remove(), 2500);
        }

        /* ----- „Çª„Éº„Éñ„Éª„É≠„Éº„Éâ„Éª„É™„Çª„ÉÉ„ÉàÔºàÂÆâÂÖ®„Å™„Éû„Éº„Ç∏Ôºâ ----- */
        function saveGame() {
            const save = {
                gameState,
                producers,
                upgrades,
                artifacts,
                achievements,
                ts: Date.now()
            }

                ;

            try {
                localStorage.setItem(GAME_SAVE_KEY, JSON.stringify(save));
                notify('„Çª„Éº„Éñ„Åó„Åæ„Åó„Åü');
            }

            catch (e) {
                console.error('„Çª„Éº„ÉñÂ§±Êïó', e);
                notify('„Çª„Éº„Éñ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
            }
        }

        function loadGame(silent = false) {
            const raw = localStorage.getItem(GAME_SAVE_KEY);

            if (!raw) {
                if (!silent) notify('„Çª„Éº„Éñ„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì');
                return;
            }

            try {
                const save = JSON.parse(raw);

                if (save.gameState) {
                    gameState = Object.assign(gameState, save.gameState);
                    // Ensure new fields exist
                    if (typeof gameState.reincarnationCount === 'undefined') gameState.reincarnationCount = 0;
                    if (typeof gameState.prestigeMultiplier === 'undefined') gameState.prestigeMultiplier = 1.0;
                }

                if (save.producers) {
                    producers = defaultProducers.map(d => {
                        const s = (save.producers || []).find(x => x.id === d.id) || {}

                            ;

                        return Object.assign({}

                            , d, {
                            count: s.count ?? d.count
                        });
                    });
                }

                if (save.upgrades) {
                    upgrades = defaultUpgrades.map(d => {
                        const s = (save.upgrades || []).find(x => x.id === d.id) || {}

                            ;

                        return Object.assign({}

                            , d, {
                            bought: s.bought ?? d.bought
                        });
                    });
                }

                if (save.artifacts) {
                    artifacts = defaultArtifacts.map(d => {
                        const s = (save.artifacts || []).find(x => x.id === d.id) || {}

                            ;

                        return Object.assign({}

                            , d, {
                            bought: s.bought ?? false
                        });
                    });
                }

                if (save.achievements) {
                    achievements = defaultAchievements.map(d => {
                        const s = (save.achievements || []).find(x => x.id === d.id) || {}

                            ;

                        return Object.assign({}

                            , d, {
                            rewarded: s.rewarded ?? d.rewarded
                        });
                    });
                }

                // „Ç™„Éï„É©„Ç§„É≥Ë£úÂ°´Ôºà‰øùÂ≠òÊôÇÂàª„Åå„ÅÇ„Çå„Å∞Â∑ÆÂàÜ„ÇíË£úÂ°´Ôºâ
                if (save.ts) {
                    const elapsedSec = Math.floor((Date.now() - save.ts) / 1000);

                    if (elapsedSec > 1) {
                        const prod = calcProdPerSecond();
                        const offlineGain = prod * elapsedSec;
                        gameState.money += offlineGain;
                        gameState.totalZ += offlineGain;
                        gameState.playTimeSec += elapsedSec;

                        notify(`ÊîæÁΩÆÂ†±ÈÖ¨: ${formatNum(offlineGain)
                            }

            ZÔºà${elapsedSec
                            }

            sÂàÜÔºâ`);

                        // Ë£úÂ°´Âæå„Å´ÂÆüÁ∏æÂà§ÂÆö
                        try {
                            checkAchievements();
                        }

                        catch (e) {
                            console.error(e)
                        }
                    }
                }

                updateUI();
                if (!silent) notify('„É≠„Éº„ÉâÂÆå‰∫Ü');
            }

            catch (e) {
                console.error(e);
                notify('„É≠„Éº„Éâ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
            }
        }

        function resetGame() {
            const canReincarnate = gameState.money >= 1000000;
            const msg = canReincarnate ? 'Ëª¢Áîü„Åó„Åæ„Åô„ÅãÔºü\nÁèæÂú®„ÅÆÊâÄÊåÅÈáë„Å´Âøú„Åò„Å¶ÁîüÁî£„Éú„Éº„Éä„Çπ„ÇíÁç≤Âæó„Åó„ÄÅÂº∑„Åè„Å¶„Éã„É•„Éº„Ç≤„Éº„É†„Åó„Åæ„Åô„ÄÇ'
                : 'Êú¨ÂΩì„Å´„É™„Çª„ÉÉ„Éà„Åó„Åæ„Åô„ÅãÔºü „Çª„Éº„Éñ„ÅØÊ∂à„Åà„Åæ„Åô„ÄÇ';

            if (!confirm(msg)) return;

            let nextPrestige = gameState.prestigeMultiplier || 1.0;
            let nextCount = gameState.reincarnationCount || 0;

            if (canReincarnate) {
                // Formula: +10% per sqrt(1M)
                // e.g. 1M => sqrt(1) * 0.1 = +0.1
                // 4M => sqrt(4) * 0.1 = +0.2
                const bonus = Math.sqrt(gameState.money / 1000000) * 0.1;
                nextPrestige += bonus;
                nextCount += 1;

                notify(`Ëª¢ÁîüÂÆå‰∫ÜÔºÅ „Éú„Éº„Éä„Çπ +${(bonus * 100).toFixed(1)
                    }

            %`);
            }

            else {
                notify('ÂàùÊúüÂåñ„Åó„Åæ„Åó„Åü');
            }

            // „Éá„Éï„Ç©„É´„ÉàÂÆöÁæ©„Åã„Çâ„Ç≥„Éî„ÉºÔºàÈñ¢Êï∞„Çí‰øùÊåÅÔºâ
            producers = defaultProducers.map(p => ({
                ...p
            }));

            upgrades = defaultUpgrades.map(u => ({
                ...u
            }));

            artifacts = defaultArtifacts.map(a => ({
                ...a, bought: false
            }));

            // Achievements are NOT reset on reincarnation (usually) but here we follow simple logic:
            // If simple reset, wipe all. If reincarnation, maybe keep? 
            // For now, let's keep achievements on Reincarnation, wipe on Reset.
            // Achievements are reset on both Reset and Reincarnation as per request
            achievements = defaultAchievements.map(a => ({
                ...a,
                rewarded: false // Explicitly reset
            }));

            if (canReincarnate) {
                // Keep stats if needed or handled above
            }


            gameState = {

                money: 0,
                totalZ: 0,
                clickPower: 1,
                globalMultiplier: 1,
                producerMultipliers: {}

                ,
                playTimeSec: 0,
                // Maybe keep playTime? Let's reset for "run time"
                reincarnationCount: nextCount,
                prestigeMultiplier: nextPrestige,
                lastTick: Date.now()
            }

                ;

            saveGame(); // Save immediately
            updateUI();
        }

        /* ----- „É¶„Éº„Ç∂„ÉºÊìç‰ΩúÔºö„ÇØ„É™„ÉÉ„ÇØ„ÅßZ„ÇíÁç≤Âæó ----- */
        const tapEl = document.getElementById('tapGain');

        if (tapEl) {
            tapEl.addEventListener('click', () => {
                gameState.money += gameState.clickPower;
                gameState.totalZ += gameState.clickPower;

                // „ÇØ„É™„ÉÉ„ÇØ„ÅßÂÆüÁ∏æ„ÅåÂ§â„Çè„ÇãÂèØËÉΩÊÄß„Åå„ÅÇ„Çã„Åü„ÇÅ„ÉÅ„Çß„ÉÉ„ÇØ
                try {
                    checkAchievements();
                }

                catch (e) {
                    console.error(e)
                }

                updateUI();
            });
        }

        /* ----- „Çø„ÉñÂàáÊõøÂá¶ÁêÜÔºàÂè≥„Ç´„É©„É†Ôºâ ----- */
        let currentTab = 'mono';
        const tabButtons = document.querySelectorAll('.tab-btn');

        tabButtons.forEach(b => {
            b.addEventListener('click', () => {
                tabButtons.forEach(bb => bb.classList.remove('active'));
                b.classList.add('active');
                currentTab = b.dataset.tab;
                const content = document.getElementById('tabContent');
                content.innerHTML = '';

                if (currentTab === 'mono') {
                    const div = document.createElement('div'); div.id = 'monoPanel';
                    content.appendChild(div);
                    renderMonoPanel();
                }

                else if (currentTab === 'chie') {
                    renderChiePanel();
                }

                else if (currentTab === 'ach') {
                    renderAchPanel();
                }
            });
        });

        /* ----- „Éú„Çø„É≥Ôºà„Çª„Éº„ÉñÁ≠âÔºâ„ÅÆÊé•Á∂ö ----- */
        const saveBtn = document.getElementById('saveBtn');
        if (saveBtn) saveBtn.addEventListener('click', saveGame);
        const loadBtn = document.getElementById('loadBtn');
        if (loadBtn) loadBtn.addEventListener('click', () => loadGame(false));
        const resetBtn = document.getElementById('resetBtn');
        if (resetBtn) resetBtn.addEventListener('click', resetGame);

        /* ----- Ëá™Âãï„Çª„Éº„ÉñÔºà‰∏ÄÂÆöÈñìÈöîÔºâ ----- */
        setInterval(() => {
            saveGame();
        }

            , 60000);

        /* ----- „É°„Ç§„É≥„É´„Éº„ÉóÔºàrequestAnimationFrameÔºâ ----- */
        let lastTime = performance.now();
        let uiTimer = 0;

        function mainLoop(now) {
            const dtMs = now - lastTime;
            lastTime = now;
            const dt = dtMs / 1000;
            tick(dt);

            uiTimer += dt;

            if (uiTimer >= 1.0) {
                updateUI();
                uiTimer = 0;
            }

            requestAnimationFrame(mainLoop);
        }

        /* ----- CodePen„Å™„Å©„ÅßrAF„ÅåÊ≠¢„Åæ„Å£„ÅüÂ†¥Âêà„ÅÆË£úÂ°´Ôºà„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÔºâ ----- */
        /*
                  rAF „ÅåÂÅúÊ≠¢„Åó„Å¶„ÅÑ„ÇãÔºà/Ê•µÁ´Ø„Å´ÈñìÂºï„Åã„Çå„Å¶„ÅÑ„ÇãÔºâÁí∞Â¢É„Åß„ÅØ tick „ÅåÂëº„Å∞„Çå„ÅöÊîæÁΩÆÂàÜ„ÅåÂ§±„Çè„Çå„Çã„ÄÇ
                  „Åù„Åì„Åß tick „ÅåÊ≠¢„Åæ„Å£„Å¶„ÅÑ„ÇãÊôÇÈñì„Çí _lastTickTime „ÅßÂà§ÂÆö„Åó„ÄÅsetInterval „Åß„Åæ„Å®„ÇÅ„Å¶Ë£úÂ°´„Åô„Çã„ÄÇ
                  - rAF „ÅåÂãï„ÅÑ„Å¶„ÅÑ„ÇãÂ†¥ÂêàÔºàtick„ÅåÊõ¥Êñ∞„Åó„Å¶„ÅÑ„Çã„Å®„ÅçÔºâ„ÅØ‰Ωï„ÇÇ„Åó„Å™„ÅÑÔºà‰∫åÈáçÂä†ÁÆó„ÇíÈò≤Ê≠¢Ôºâ„ÄÇ
                */
        setInterval(() => {
            const now = Date.now();
            const elapsed = (now - _lastTickTime) / 1000;
            // rAF„ÅåÂãï„ÅÑ„Å¶„ÅÑ„Çå„Å∞ elapsed „ÅØÈùûÂ∏∏„Å´Â∞è„Åï„ÅÑ„ÅÆ„Åß‰Ωï„ÇÇ„Åó„Å™„ÅÑ
            if (elapsed < 0.5) return;

            // rAF„ÅåÊ≠¢„Åæ„Å£„Å¶„ÅÑ„ÇãÊôÇÈñì„Å†„Åë„Åæ„Å®„ÇÅ„Å¶Âä†ÁÆó
            const prod = calcProdPerSecond();
            const gain = prod * elapsed;

            if (gain > 0) {
                gameState.money += gain;
                gameState.totalZ += gain;
                gameState.playTimeSec += elapsed;

                try {
                    checkAchievements();
                }

                catch (e) {
                    console.error(e)
                }

                try {
                    updateUI();
                }

                catch (e) {
                    console.error(e)
                }
            }

            _lastTickTime = now;
        }

            , 1000);

        /* ----- ÂàùÊúüÂåñÂá¶ÁêÜÔºàËµ∑ÂãïÊôÇ„Å´‰∏ÄÂ∫¶„Å†„ÅëÂÆüË°åÔºâ ----- */
        (function init() {
            // „Çª„Éº„Éñ„Åå„ÅÇ„Çå„Å∞Ë™≠„ÅøËæº„ÇÄÔºàËµ∑ÂãïÊôÇ„ÅØÈÄöÁü•„ÇíÊéß„Åà„ÇãÔºâ
            loadGame(true);

            // ÂàùÂõûUIÊõ¥Êñ∞
            updateUI();
            // „É°„Ç§„É≥„É´„Éº„ÉóÈñãÂßã
            requestAnimationFrame(mainLoop);
        })();

        /* ----- Ë£úÂä©Ôºö„ÅäÈáë‰∏çË∂≥„ÅÆ„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØÔºàÁü≠ÊôÇÈñìÁÇπÊªÖÔºâ ----- */
        function flashInsufficient() {
            const el = document.getElementById('money');
            if (!el) return;
            el.style.transition = 'none';
            el.style.color = '#ffb4b4';

            setTimeout(() => {
                el.style.transition = 'color 400ms'; el.style.color = '#fff'
            }

                , 220);
        }

    </script>
</body>

</html>
