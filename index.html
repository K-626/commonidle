<!doctype html>
<html lang="ja">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>ç°¡æ˜“æ”¾ç½®ã‚²ãƒ¼ãƒ ï¼ˆZï¼‰</title>
    <style>
        :root {
            --bg: #0f1724;
            --panel: #0b1220;
            --accent: #7dd3fc;
            --muted: #94a3b8;
            --card: #0e1a2b;
            --glass: rgba(255, 255, 255, 0.03);
            --glass-2: rgba(255, 255, 255, 0.02);
            --radius: 12px;
            font-family: "Noto Sans JP", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
        }

        html,
        body {
            height: 100%;
            margin: 0;
            background: linear-gradient(180deg, #071029 0%, #061727 100%);
            color: #e6eef6
        }

        .container {
            display: grid;
            grid-template-columns: 1fr 2fr 320px;
            gap: 16px;
            height: 100vh;
            padding: 18px;
            box-sizing: border-box;
        }

        /* Left column */
        .left {
            background: linear-gradient(180deg, var(--panel), #061424);
            border-radius: var(--radius);
            padding: 16px;
            box-shadow: 0 6px 18px rgba(2, 6, 23, 0.6);
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .left-top {
            background: var(--glass);
            padding: 14px;
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
        }

        .money {
            display: flex;
            flex-direction: column;
        }

        .money .label {
            font-size: 13px;
            color: var(--muted)
        }

        .money .value {
            font-size: 22px;
            font-weight: 700;
            color: #fff;
            letter-spacing: 0.02em;
        }

        .zps {
            text-align: right;
        }

        .zps .label {
            font-size: 13px;
            color: var(--muted)
        }

        .zps .value {
            font-size: 18px;
            font-weight: 600;
            color: var(--accent)
        }

        .left-middle {
            flex: 1;
            background: var(--glass-2);
            border-radius: 10px;
            padding: 12px;
            overflow: auto;
        }

        /* Center column */
        .center {
            background: linear-gradient(180deg, #07182a, #051223);
            border-radius: var(--radius);
            padding: 18px;
            display: flex;
            flex-direction: column;
            gap: 16px;
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.6);
        }

        .big-action {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 14px;
            flex-wrap: wrap;
        }

        .big-click {
            background: linear-gradient(180deg, #0ea5a0, #046b6b);
            border-radius: 18px;
            padding: 22px 28px;
            font-size: 20px;
            font-weight: 700;
            cursor: pointer;
            user-select: none;
            box-shadow: 0 8px 30px rgba(4, 139, 139, 0.18), inset 0 -4px 12px rgba(255, 255, 255, 0.03);
        }

        .mini-info {
            background: var(--glass);
            padding: 12px 16px;
            border-radius: 12px;
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .center-bottom {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
        }

        .card {
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.02), rgba(255, 255, 255, 0.01));
            padding: 12px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.03);
        }

        /* Artifact Tree */
        .artifact-panel {
            background: var(--card);
            border-radius: 12px;
            padding: 16px;
            position: relative;
            min-height: 300px;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .artifact-tree-svg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
        }

        .artifact-node {
            position: absolute;
            transform: translate(-50%, -50%);
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: linear-gradient(180deg, #1f2937, #111827);
            border: 2px solid #374151;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 20px;
            cursor: pointer;
            z-index: 1;
            transition: all 0.2s;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .artifact-node:hover {
            transform: translate(-50%, -50%) scale(1.1);
            border-color: var(--accent);
            z-index: 10;
        }

        .artifact-node.bought {
            background: linear-gradient(180deg, #0ea5e9, #0284c7);
            border-color: #7dd3fc;
            box-shadow: 0 0 15px rgba(14, 165, 233, 0.4);
        }

        .artifact-node.locked {
            opacity: 0.5;
            cursor: not-allowed;
            filter: grayscale(1);
        }

        .artifact-node.available {
            border-color: #fbbf24;
            animation: pulse-border 2s infinite;
        }

        @keyframes pulse-border {
            0% {
                box-shadow: 0 0 0 0 rgba(251, 191, 36, 0.4);
            }

            70% {
                box-shadow: 0 0 0 6px rgba(251, 191, 36, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(251, 191, 36, 0);
            }
        }

        .artifact-tooltip {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 12px;
            pointer-events: none;
            white-space: nowrap;
            z-index: 20;
            border: 1px solid rgba(255, 255, 255, 0.1);
            display: none;
        }

        /* Right column (tabbed area) */
        .right {
            background: linear-gradient(180deg, #071826, #04121a);
            border-radius: var(--radius);
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            box-shadow: 0 8px 22px rgba(2, 6, 23, 0.6);
        }

        .tabs {
            display: flex;
            gap: 10px;
        }

        .tab-btn {
            flex: 1;
            padding: 10px 12px;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            user-select: none;
            background: transparent;
            color: var(--muted);
            border: 1px solid transparent;
            font-weight: 700;
        }

        .tab-btn.active {
            background: linear-gradient(180deg, rgba(125, 211, 252, 0.12), rgba(125, 211, 252, 0.06));
            color: var(--accent);
            border: 1px solid rgba(125, 211, 252, 0.12);
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.45);
        }

        .tab-content {
            background: var(--card);
            border-radius: 10px;
            padding: 12px;
            flex: 1;
            overflow: auto;
        }

        /* Producer list */
        .producer {
            display: flex;
            justify-content: space-between;
            gap: 10px;
            align-items: center;
            padding: 8px;
            border-radius: 8px;
            margin-bottom: 8px;
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.01), rgba(255, 255, 255, 0.00));
            border: 1px solid rgba(255, 255, 255, 0.02);
        }

        .producer .left {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .producer .name {
            font-weight: 700
        }

        .producer .meta {
            font-size: 12px;
            color: var(--muted)
        }

        .buy-btn {
            padding: 8px 10px;
            border-radius: 8px;
            cursor: pointer;
            background: linear-gradient(180deg, #1f2937, #0f1724);
            color: #e6eef6;
            border: 1px solid rgba(255, 255, 255, 0.03);
            font-weight: 700;
        }

        .buy-btn:disabled {
            opacity: 0.45;
            cursor: not-allowed
        }

        /* Upgrades */
        .upgrade {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            padding: 8px;
            border-radius: 8px;
            margin-bottom: 8px;
            border: 1px solid rgba(255, 255, 255, 0.02);
        }

        /* Achievements */
        .ach {
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 8px;
            background: rgba(255, 255, 255, 0.01);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }

        .ach.locked {
            opacity: 0.5
        }

        /* footer small */
        .small {
            font-size: 12px;
            color: var(--muted);
            text-align: center;
            padding: 6px;
        }

        /* responsive */
        @media(max-width:900px) {
            .container {
                grid-template-columns: 1fr;
                grid-auto-rows: min-content;
                padding: 12px;
                gap: 12px;
            }

            .right {
                order: 3
            }

            .left {
                order: 1
            }

            .center {
                order: 2
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- LEFT -->
        <div class="left" id="leftPanel">
            <div class="left-top">
                <div class="money">
                    <div class="label">æ‰€æŒZ</div>
                    <div class="value" id="money">0</div>
                </div>
                <div class="zps">
                    <div class="label">1ç§’ã‚ãŸã‚Šã®ç”Ÿç”£</div>
                    <div class="value" id="zps">0 Z/s</div>
                </div>
            </div>

            <div class="left-middle" id="leftMiddle">
                <h3 style="margin:6px 0 10px 0">çµ±è¨ˆ / ã‚»ãƒ¼ãƒ–</h3>
                <div class="card" style="margin-bottom:8px">
                    <div>ç·ç²å¾—Z: <span id="totalZ">0</span></div>
                    <div>ãƒ—ãƒ¬ã‚¤æ™‚é–“: <span id="playTime">0s</span></div>
                    <div style="margin-top:4px; border-top:1px solid rgba(255,255,255,0.1); padding-top:4px">
                        <div style="font-size:12px;color:var(--muted)">è»¢ç”Ÿå›æ•°: <span id="reincarnationCount">0</span>
                        </div>
                        <div style="font-size:12px;color:var(--muted)">è»¢ç”Ÿãƒœãƒ¼ãƒŠã‚¹: <span id="prestigeMult">x1.00</span>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <button id="saveBtn" class="buy-btn" style="width:100%;margin-bottom:8px">ã‚»ãƒ¼ãƒ–</button>
                    <button id="loadBtn" class="buy-btn" style="width:100%;margin-bottom:8px">ãƒ­ãƒ¼ãƒ‰</button>
                    <button id="resetBtn" class="buy-btn"
                        style="width:100%;background:#7f1d1d;border-color:#7f1d1d">ãƒªã‚»ãƒƒãƒˆ</button>
                </div>
            </div>
        </div>

        <!-- CENTER -->
        <div class="center">
            <div class="big-action">
                <div class="big-click" id="tapGain">ã‚¯ãƒªãƒƒã‚¯ã§Zã‚’å¾—ã‚‹</div>
                <div class="mini-info card">
                    <div>
                        <div style="font-size:12px; color:var(--muted)">ã‚¯ãƒªãƒƒã‚¯ã§å¾—ã‚‰ã‚Œã‚‹Z</div>
                        <div style="font-weight:700; font-size:16px" id="clickValue">1</div>
                    </div>
                    <div style="margin-left:auto;text-align:right">
                        <div style="font-size:12px;color:var(--muted)">æ¬¡ã®æ‘äººä¾¡æ ¼</div>
                        <div style="font-weight:700" id="nextVillagerCost">--</div>
                    </div>
                </div>
            </div>

            <!-- Artifact Tree Section -->
            <div class="artifact-panel" id="artifactPanel">
                <h4 style="margin:0 0 12px 0; text-align:center; color:var(--muted)">ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆ</h4>
                <svg class="artifact-tree-svg" id="treeSvg"></svg>
                <div id="treeNodes"></div>
                <div class="artifact-tooltip" id="artifactTooltip"></div>
            </div>


        </div>

        <!-- RIGHT -->
        <div class="right">
            <div class="tabs">
                <div class="tab-btn active" data-tab="mono" id="tabMono">ãƒ¢ãƒ</div>
                <div class="tab-btn" data-tab="chie" id="tabChie">çŸ¥æµ</div>
                <div class="tab-btn" data-tab="ach" id="tabAch">å®Ÿç¸¾</div>
            </div>

            <div class="tab-content" id="tabContent">
                <!-- default: ãƒ¢ãƒ -->
                <div id="monoPanel"></div>
            </div>

            <div style="display:flex;gap:8px">
                <div style="flex:1" class="small">ãƒãƒ¼ã‚¸ãƒ§ãƒ³: 1.0 Â· ä¿å­˜ã¯ãƒ–ãƒ©ã‚¦ã‚¶ã«ä¿æŒ</div>
            </div>
        </div>
    </div>
    <script>
        /*
          æ—¥æœ¬èªã‚³ãƒ¡ãƒ³ãƒˆä»˜ã JavaScriptï¼ˆä¿®æ­£ç‰ˆãƒ»å®Œå…¨ç‰ˆï¼‰
          â€» æ©Ÿèƒ½ã¯å…ƒã®ã¾ã¾ã€ãƒã‚°ä¿®æ­£ã¨æœ€å°ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã®ã¿ã‚’è¿½åŠ ã—ã¦ã„ã¾ã™ã€‚
        */

        /* ----- å®šæ•°ã¨åˆæœŸãƒ‡ãƒ¼ã‚¿ ----- */
        const GAME_SAVE_KEY = "idle_z_save_v1";

        const defaultProducers = [
            { id: 'villager', name: 'æ‘äºº', baseCost: 10, costMult: 1.15, baseProd: 0.5, count: 0, icon: 'ğŸ‘¨â€ğŸŒ¾' },
            { id: 'farmer', name: 'è¾²å¤«', baseCost: 120, costMult: 1.15, baseProd: 6, count: 0, icon: 'ğŸŒ¾' },
            { id: 'miner', name: 'æ¡æ˜è€…', baseCost: 1500, costMult: 1.15, baseProd: 80, count: 0, icon: 'â›ï¸' },
            { id: 'factory', name: 'å·¥å ´', baseCost: 20000, costMult: 1.17, baseProd: 1200, count: 0, icon: 'ğŸ­' }
        ];

        const defaultUpgrades = [
            { id: 'clickBoost', name: 'ã‚¯ãƒªãƒƒã‚¯åŠ¹ç‡ +2', desc: 'ã‚¯ãƒªãƒƒã‚¯ã§å¾—ã‚‹ZãŒå¢—ãˆã‚‹', cost: 50, bought: false, apply: (g) => { g.clickPower += 2 } },
            { id: 'prodBoost1', name: 'ç”Ÿç”£åŠ¹ç‡ +25%', desc: 'å…¨ãƒ¦ãƒ‹ãƒƒãƒˆã®ç”Ÿç”£ãŒ+25%', cost: 1000, bought: false, apply: (g) => { g.globalMultiplier *= 1.25 } },
            { id: 'prodBoost2', name: 'ç”Ÿç”£åŠ¹ç‡ +100%', desc: 'å…¨ãƒ¦ãƒ‹ãƒƒãƒˆã®ç”Ÿç”£ãŒ+100%', cost: 20000, bought: false, apply: (g) => { g.globalMultiplier *= 2 } },
            {
                id: 'intensiveFarming', name: 'é›†ç´„çš„è¾²æ¥­', desc: 'æ‘äººã¨è¾²å¤«ã®ç”Ÿç”£ãŒ+500%', cost: 5000, bought: false, apply: (g) => {
                    if (!g.producerMultipliers) g.producerMultipliers = {};
                    g.producerMultipliers['villager'] = (g.producerMultipliers['villager'] || 1) * 6;
                    g.producerMultipliers['farmer'] = (g.producerMultipliers['farmer'] || 1) * 6;
                }
            }
        ];

        const defaultArtifacts = [
            { id: 'art_tablet', name: 'å¤ä»£ã®çŸ³æ¿', desc: 'ç”Ÿç”£åŠ¹ç‡ +10000%', cost: 100, x: 50, y: 20, parent: null, icon: 'ğŸ“œ', apply: (g) => { g.globalMultiplier *= 101; } },
            { id: 'art_stone', name: 'çŸ³ã®é“å…·', desc: 'ã‚¯ãƒªãƒƒã‚¯ +500', cost: 500, x: 30, y: 50, parent: 'art_tablet', icon: 'ğŸª¨', apply: (g) => { g.clickPower += 500; } },
            {
                id: 'art_irrig', name: 'çŒæ¼‘', desc: 'è¾²å¤«ã®ç”Ÿç”£ +5000%', cost: 1000, x: 70, y: 50, parent: 'art_tablet', icon: 'ğŸ’§', apply: (g) => {
                    if (!g.producerMultipliers) g.producerMultipliers = {};
                    g.producerMultipliers['farmer'] = (g.producerMultipliers['farmer'] || 1) * 51;
                }
            },
            { id: 'art_iron', name: 'é‰„ã®é“å…·', desc: 'ã‚¯ãƒªãƒƒã‚¯ +1000', cost: 2000, x: 20, y: 80, parent: 'art_stone', icon: 'âš”ï¸', apply: (g) => { g.clickPower += 1000; } },
            {
                id: 'art_crop', name: 'è¼ªä½œ', desc: 'è¾²å¤«ã®ç”Ÿç”£ +10000%', cost: 5000, x: 80, y: 80, parent: 'art_irrig', icon: 'ğŸ”„', apply: (g) => {
                    if (!g.producerMultipliers) g.producerMultipliers = {};
                    g.producerMultipliers['farmer'] = (g.producerMultipliers['farmer'] || 1) * 101;
                }
            }
        ];

        const defaultAchievements = [
            { id: 'firstZ', name: 'æœ€åˆã®10Z', desc: 'Zã‚’10ç²å¾—', condition: gs => gs.totalZ >= 10, rewarded: false, reward: gs => { gs.money += 20 } },
            { id: 'hundredZ', name: 'Zã‚’100ç²å¾—', desc: 'Zã‚’100ç²å¾—', condition: gs => gs.totalZ >= 100, rewarded: false, reward: gs => { gs.globalMultiplier *= 1.10 } },
            { id: 'hireOne', name: 'æ‘äººã‚’é›‡ã†', desc: 'æ‘äººã‚’1äººé›‡ã†', condition: gs => producers.find(p => p.id === 'villager').count >= 1, rewarded: false, reward: gs => { gs.money += 5 } }
        ];

        /* ----- ã‚²ãƒ¼ãƒ çŠ¶æ…‹ï¼ˆå¯å¤‰ï¼‰ ----- */

        // é–¢æ•°ã‚’ä¿ã£ãŸã¾ã¾ã‚³ãƒ”ãƒ¼ã™ã‚‹ï¼ˆJSONç³»ã¯é–¢æ•°ã‚’æ¶ˆã™ã®ã§ä½¿ã‚ãªã„ï¼‰
        let producers = defaultProducers.map(p => ({ ...p }));
        let upgrades = defaultUpgrades.map(u => ({ ...u }));
        let artifacts = defaultArtifacts.map(a => ({ ...a, bought: false }));
        let achievements = defaultAchievements.map(a => ({ ...a }));

        let gameState = {
            money: 0,
            totalZ: 0,
            clickPower: 1,
            globalMultiplier: 1,
            producerMultipliers: {},
            playTimeSec: 0,
            reincarnationCount: 0,
            prestigeMultiplier: 1.0,
            lastTick: Date.now()
        };

        /* ----- ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”¨ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ï¼ˆrAFãŒæ­¢ã¾ã£ãŸã‹åˆ¤å®šã™ã‚‹ãŸã‚ï¼‰ ----- */
        let _lastTickTime = Date.now();

        /* ----- ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•° ----- */
        function formatNum(n) {
            if (!isFinite(n)) return '0';
            if (n >= 1e12) return (n / 1e12).toFixed(2) + 'T';
            if (n >= 1e9) return (n / 1e9).toFixed(2) + 'B';
            if (n >= 1e6) return (n / 1e6).toFixed(2) + 'M';
            if (n >= 1000) return (n / 1000).toFixed(2) + 'k';
            if (Math.abs(n - Math.round(n)) < 1e-9) return String(Math.round(n));
            return Number(n.toFixed(2)).toString();
        }

        function calcProdPerSecond() {
            let sum = 0;
            for (const p of producers) {
                let mult = 1;
                if (gameState.producerMultipliers && gameState.producerMultipliers[p.id]) {
                    mult = gameState.producerMultipliers[p.id];
                }
                sum += (p.count || 0) * p.baseProd * mult;
            }
            sum *= gameState.globalMultiplier;
            sum *= (gameState.prestigeMultiplier || 1);
            return sum;
        }

        function nextCost(p) {
            return Math.floor(p.baseCost * Math.pow(p.costMult, p.count));
        }

        /* ----- UI æ›´æ–°å‡¦ç†ï¼ˆè¡¨ç¤ºã‚’æœ€æ–°åŒ–ï¼‰ ----- */
        function updateUI() {
            const elMoney = document.getElementById('money');
            if (elMoney) elMoney.textContent = formatNum(gameState.money);
            const elZps = document.getElementById('zps');
            if (elZps) elZps.textContent = formatNum(calcProdPerSecond()) + ' Z/s';
            const elTotal = document.getElementById('totalZ');
            if (elTotal) elTotal.textContent = formatNum(gameState.totalZ);
            const elPlay = document.getElementById('playTime');
            if (elPlay) elPlay.textContent = Math.floor(gameState.playTimeSec) + 's';
            const elClick = document.getElementById('clickValue');
            if (elClick) elClick.textContent = formatNum(gameState.clickPower) + ' Z';
            const vill = producers.find(p => p.id === 'villager');
            const elNextVill = document.getElementById('nextVillagerCost');
            if (elNextVill) elNextVill.textContent = vill ? formatNum(nextCost(vill)) : '--';

            const elRein = document.getElementById('reincarnationCount');
            if (elRein) elRein.textContent = gameState.reincarnationCount || 0;
            const elPrestige = document.getElementById('prestigeMult');
            if (elPrestige) elPrestige.textContent = 'x' + (gameState.prestigeMultiplier || 1).toFixed(2);

            // Reset Button Text
            const resetBtn = document.getElementById('resetBtn');
            if (resetBtn) {
                if (gameState.money >= 1000000) {
                    resetBtn.textContent = 'è»¢ç”Ÿã™ã‚‹';
                    resetBtn.style.background = 'linear-gradient(180deg, #f59e0b, #d97706)';
                    resetBtn.style.borderColor = '#f59e0b';
                } else {
                    resetBtn.textContent = 'ãƒªã‚»ãƒƒãƒˆ';
                    resetBtn.style.background = '#7f1d1d';
                    resetBtn.style.borderColor = '#7f1d1d';
                }
            }

            renderMonoPanel();
            renderChiePanel();
            renderAchPanel();
            renderArtifactTree();
        }

        /* ----- ãƒ¡ã‚¤ãƒ³å‡¦ç†ï¼šæ™‚é–“çµŒéã¨ç”Ÿç”£ï¼ˆã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ—ï¼‰ ----- */
        function tick(dt) {
            // rAFãŒæ­£å¸¸ã«å‹•ã„ã¦ã„ã‚‹ã“ã¨ã‚’ç¤ºã™ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—æ›´æ–°
            _lastTickTime = Date.now();

            const prod = calcProdPerSecond();
            const gain = prod * dt;

            gameState.money += gain;
            gameState.totalZ += gain;
            gameState.playTimeSec += dt;

            checkAchievements();
        }

        /* ----- ãƒ¢ãƒï¼ˆãƒ—ãƒ­ãƒ‡ãƒ¥ãƒ¼ã‚µï¼‰ãƒ‘ãƒãƒ«ã®æç”»ã¨è³¼å…¥å‡¦ç† ----- */
        function renderMonoPanel() {
            const container = document.getElementById('monoPanel');
            if (!container) return;
            container.innerHTML = '';
            for (const p of producers) {
                const el = document.createElement('div');
                el.className = 'producer';
                el.innerHTML = `
      <div class="left">
        <div style="font-size:20px">${p.icon}</div>
        <div>
          <div class="name">${p.name} <span style="font-size:12px;color:var(--muted)">x${p.count}</span></div>
          <div class="meta">ç”Ÿç”£: ${formatNum(p.baseProd)} Z/s</div>
        </div>
      </div>
      <div style="text-align:right">
        <div style="font-size:13px;color:var(--muted)">ä¾¡æ ¼</div>
        <div style="font-weight:700">${formatNum(nextCost(p))} Z</div>
        <div style="margin-top:8px"><button class="buy-btn" data-id="${p.id}" ${gameState.money < nextCost(p) ? 'disabled' : ''}>è³¼å…¥</button></div>
      </div>
    `;
                container.appendChild(el);
            }

            container.querySelectorAll('.buy-btn').forEach(b => {
                b.onclick = () => {
                    const id = b.getAttribute('data-id');
                    buyProducer(id);
                }
            });
        }

        function buyProducer(id) {
            const p = producers.find(x => x.id === id);
            if (!p) return;
            const cost = nextCost(p);

            if (gameState.money >= cost) {
                gameState.money -= cost;
                p.count += 1;

                if (p.count % 10 === 0) {
                    gameState.money += Math.floor(p.baseProd * 5 * gameState.globalMultiplier);
                }

                // å®Ÿç¸¾åˆ¤å®šã‚’ç¢ºå®Ÿã«è¡Œã†ï¼ˆè³¼å…¥ã§é”æˆã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚ï¼‰
                try { checkAchievements(); } catch (e) { console.error(e); }

                updateUI();

            } else {
                flashInsufficient();
            }
        }

        /* ----- ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ï¼ˆçŸ¥æµï¼‰ ----- */
        function renderChiePanel() {
            const container = document.getElementById('tabContent');
            if (!container) return;
            if (currentTab !== 'chie') return;

            const panel = document.createElement('div');
            panel.id = 'chiePanel';
            if (upgrades.length === 0) {
                panel.textContent = 'ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚';
            } else {
                for (const u of upgrades) {
                    const d = document.createElement('div');
                    d.className = 'upgrade';
                    d.innerHTML = `
        <div>
          <div style="font-weight:700">${u.name} ${u.bought ? 'ï¼ˆè³¼å…¥æ¸ˆï¼‰' : ''}</div>
          <div style="font-size:13px;color:var(--muted)">${u.desc}</div>
        </div>
        <div style="text-align:right">
          <div style="font-size:13px;color:var(--muted)">ä¾¡æ ¼</div>
          <div style="font-weight:700">${formatNum(u.cost)} Z</div>
          <div style="margin-top:8px">
            <button class="buy-btn" data-upg="${u.id}" ${u.bought || gameState.money < u.cost ? 'disabled' : ''}>è³¼å…¥</button>
          </div>
        </div>
      `;
                    panel.appendChild(d);
                }
            }
            container.innerHTML = '';
            container.appendChild(panel);

            container.querySelectorAll('.buy-btn').forEach(b => {
                b.onclick = () => {
                    const id = b.getAttribute('data-upg');
                    buyUpgrade(id);
                }
            });
        }

        function buyUpgrade(id) {
            const u = upgrades.find(x => x.id === id);
            if (!u || u.bought) return;
            if (gameState.money >= u.cost) {
                gameState.money -= u.cost;
                u.bought = true;
                try { u.apply(gameState); } catch (e) { console.error(e) }

                // å®Ÿç¸¾åˆ¤å®šï¼ˆã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã§æ¡ä»¶ãŒæº€ãŸã•ã‚Œã‚‹å ´åˆãŒã‚ã‚‹ï¼‰
                try { checkAchievements(); } catch (e) { console.error(e) }

                updateUI();
            } else flashInsufficient();
        }

        /* ----- ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆï¼ˆã‚¹ã‚­ãƒ«ãƒ„ãƒªãƒ¼ï¼‰ ----- */
        function renderArtifactTree() {
            const svg = document.getElementById('treeSvg');
            const nodesContainer = document.getElementById('treeNodes');
            const tooltip = document.getElementById('artifactTooltip');
            if (!svg || !nodesContainer) return;

            // Clear previous
            svg.innerHTML = '';
            nodesContainer.innerHTML = '';

            // Draw connections
            defaultArtifacts.forEach(art => {
                if (art.parent) {
                    const parent = defaultArtifacts.find(p => p.id === art.parent);
                    if (parent) {
                        const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                        line.setAttribute('x1', parent.x + '%');
                        line.setAttribute('y1', parent.y + '%');
                        line.setAttribute('x2', art.x + '%');
                        line.setAttribute('y2', art.y + '%');

                        // Line color based on state
                        const artState = artifacts.find(a => a.id === art.id);
                        const parentState = artifacts.find(a => a.id === parent.id);
                        const isUnlocked = parentState && parentState.bought;
                        const isBought = artState && artState.bought;

                        line.setAttribute('stroke', isBought ? '#0ea5e9' : (isUnlocked ? '#4b5563' : '#1f2937'));
                        line.setAttribute('stroke-width', '2');
                        svg.appendChild(line);
                    }
                }
            });

            // Draw nodes
            artifacts.forEach(art => {
                const def = defaultArtifacts.find(d => d.id === art.id);
                const el = document.createElement('div');
                el.className = 'artifact-node';
                el.style.left = def.x + '%';
                el.style.top = def.y + '%';
                el.textContent = def.icon;

                // Determine state
                let isLocked = false;
                if (def.parent) {
                    const parent = artifacts.find(p => p.id === def.parent);
                    if (!parent || !parent.bought) isLocked = true;
                }

                if (art.bought) {
                    el.classList.add('bought');
                } else if (isLocked) {
                    el.classList.add('locked');
                } else {
                    el.classList.add('available');
                }

                // Interaction
                el.onclick = () => buyArtifact(art.id);

                // Tooltip
                el.onmouseenter = () => {
                    tooltip.style.display = 'block';
                    tooltip.innerHTML = `
                        <div style="font-weight:700;color:${art.bought ? '#7dd3fc' : '#fff'}">${def.name}</div>
                        <div style="color:#ccc">${def.desc}</div>
                        ${!art.bought ? `<div style="margin-top:4px;font-weight:700;color:${isLocked ? '#ef4444' : '#fbbf24'}">Cost: ${def.cost} Z</div>` : ''}
                    `;
                };
                el.onmouseleave = () => {
                    tooltip.style.display = 'none';
                };

                nodesContainer.appendChild(el);
            });
        }

        function buyArtifact(id) {
            const art = artifacts.find(a => a.id === id);
            const def = defaultArtifacts.find(d => d.id === id);
            if (!art || !def || art.bought) return;

            // Check parent
            if (def.parent) {
                const parent = artifacts.find(p => p.id === def.parent);
                if (!parent || !parent.bought) {
                    notify('è¦ªã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆãŒå¿…è¦ã§ã™');
                    return;
                }
            }

            if (gameState.money >= def.cost) {
                gameState.money -= def.cost;
                art.bought = true;
                try { def.apply(gameState); } catch (e) { console.error(e); }
                notify(`ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆç²å¾—: ${def.name}`);
                updateUI();
            } else {
                flashInsufficient();
            }
        }

        function renderAchPanel() {
            const container = document.getElementById('tabContent');
            if (!container) return;
            if (currentTab !== 'ach') return;

            const panel = document.createElement('div');
            panel.id = 'achPanel';
            for (const a of achievements) {
                const d = document.createElement('div');
                d.className = 'ach ' + (a.rewarded ? 'unlocked' : 'locked');
                d.innerHTML = `
      <div>
        <div style="font-weight:700">${a.name}</div>
        <div style="font-size:13px;color:var(--muted)">${a.desc}</div>
      </div>
      <div style="text-align:right">
        <div style="font-size:13px;color:${a.rewarded ? '#a6f3c5' : 'var(--muted)'}">${a.rewarded ? 'ç²å¾—æ¸ˆ' : 'æœªé”æˆ'}</div>
      </div>
    `;
                panel.appendChild(d);
            }
            container.innerHTML = '';
            container.appendChild(panel);
        }

        function checkAchievements() {
            let updated = false;
            for (const a of achievements) {
                try {
                    if (!a.rewarded && a.condition(gameState)) {
                        a.rewarded = true;
                        try { a.reward(gameState); } catch (e) { console.error(e) }
                        updated = true;
                        notify(`å®Ÿç¸¾è§£é™¤: ${a.name}`);
                    }
                } catch (e) {
                    console.error('å®Ÿç¸¾åˆ¤å®šã‚¨ãƒ©ãƒ¼', a.id, e);
                }
            }
            if (updated) updateUI();
        }

        /* ----- é€šçŸ¥ ----- */
        function notify(msg) {
            const n = document.createElement('div');
            n.textContent = msg;
            n.style.position = 'fixed';
            n.style.right = '20px';
            n.style.bottom = '20px';
            n.style.padding = '12px 18px';
            n.style.borderRadius = '8px';
            n.style.background = 'linear-gradient(180deg, rgba(125,211,252,0.15), rgba(125,211,252,0.08))';
            n.style.color = 'var(--accent)';
            n.style.boxShadow = '0 8px 24px rgba(0,0,0,0.5)';
            n.style.fontSize = '15px';
            n.style.fontWeight = '700';
            n.style.zIndex = '9999';
            document.body.appendChild(n);
            setTimeout(() => { n.style.transition = 'all 360ms ease'; n.style.opacity = '0'; n.style.transform = 'translateY(20px)'; }, 2000);
            setTimeout(() => n.remove(), 2500);
        }

        /* ----- ã‚»ãƒ¼ãƒ–ãƒ»ãƒ­ãƒ¼ãƒ‰ãƒ»ãƒªã‚»ãƒƒãƒˆï¼ˆå®‰å…¨ãªãƒãƒ¼ã‚¸ï¼‰ ----- */
        function saveGame() {
            const save = {
                gameState,
                producers,
                upgrades,
                artifacts,
                achievements,
                ts: Date.now()
            };
            try {
                localStorage.setItem(GAME_SAVE_KEY, JSON.stringify(save));
                notify('ã‚»ãƒ¼ãƒ–ã—ã¾ã—ãŸ');
            } catch (e) {
                console.error('ã‚»ãƒ¼ãƒ–å¤±æ•—', e);
                notify('ã‚»ãƒ¼ãƒ–ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

        function loadGame(silent = false) {
            const raw = localStorage.getItem(GAME_SAVE_KEY);
            if (!raw) { if (!silent) notify('ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“'); return; }
            try {
                const save = JSON.parse(raw);

                if (save.gameState) {
                    gameState = Object.assign(gameState, save.gameState);
                    // Ensure new fields exist
                    if (typeof gameState.reincarnationCount === 'undefined') gameState.reincarnationCount = 0;
                    if (typeof gameState.prestigeMultiplier === 'undefined') gameState.prestigeMultiplier = 1.0;
                }

                if (save.producers) {
                    producers = defaultProducers.map(d => {
                        const s = (save.producers || []).find(x => x.id === d.id) || {};
                        return Object.assign({}, d, { count: s.count ?? d.count });
                    });
                }

                if (save.upgrades) {
                    upgrades = defaultUpgrades.map(d => {
                        const s = (save.upgrades || []).find(x => x.id === d.id) || {};
                        return Object.assign({}, d, { bought: s.bought ?? d.bought });
                    });
                }

                if (save.artifacts) {
                    artifacts = defaultArtifacts.map(d => {
                        const s = (save.artifacts || []).find(x => x.id === d.id) || {};
                        return Object.assign({}, d, { bought: s.bought ?? false });
                    });
                }

                if (save.achievements) {
                    achievements = defaultAchievements.map(d => {
                        const s = (save.achievements || []).find(x => x.id === d.id) || {};
                        return Object.assign({}, d, { rewarded: s.rewarded ?? d.rewarded });
                    });
                }

                // ã‚ªãƒ•ãƒ©ã‚¤ãƒ³è£œå¡«ï¼ˆä¿å­˜æ™‚åˆ»ãŒã‚ã‚Œã°å·®åˆ†ã‚’è£œå¡«ï¼‰
                if (save.ts) {
                    const elapsedSec = Math.floor((Date.now() - save.ts) / 1000);
                    if (elapsedSec > 1) {
                        const prod = calcProdPerSecond();
                        const offlineGain = prod * elapsedSec;
                        gameState.money += offlineGain;
                        gameState.totalZ += offlineGain;
                        gameState.playTimeSec += elapsedSec;
                        notify(`æ”¾ç½®å ±é…¬: ${formatNum(offlineGain)} Zï¼ˆ${elapsedSec}såˆ†ï¼‰`);
                        // è£œå¡«å¾Œã«å®Ÿç¸¾åˆ¤å®š
                        try { checkAchievements(); } catch (e) { console.error(e) }
                    }
                }

                updateUI();
                if (!silent) notify('ãƒ­ãƒ¼ãƒ‰å®Œäº†');
            } catch (e) {
                console.error(e);
                notify('ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

        function resetGame() {
            const canReincarnate = gameState.money >= 1000000;
            const msg = canReincarnate
                ? 'è»¢ç”Ÿã—ã¾ã™ã‹ï¼Ÿ\nç¾åœ¨ã®æ‰€æŒé‡‘ã«å¿œã˜ã¦ç”Ÿç”£ãƒœãƒ¼ãƒŠã‚¹ã‚’ç²å¾—ã—ã€å¼·ãã¦ãƒ‹ãƒ¥ãƒ¼ã‚²ãƒ¼ãƒ ã—ã¾ã™ã€‚'
                : 'æœ¬å½“ã«ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ ã‚»ãƒ¼ãƒ–ã¯æ¶ˆãˆã¾ã™ã€‚';

            if (!confirm(msg)) return;

            let nextPrestige = gameState.prestigeMultiplier || 1.0;
            let nextCount = gameState.reincarnationCount || 0;

            if (canReincarnate) {
                // Formula: +10% per sqrt(1M)
                // e.g. 1M => sqrt(1) * 0.1 = +0.1
                // 4M => sqrt(4) * 0.1 = +0.2
                const bonus = Math.sqrt(gameState.money / 1000000) * 0.1;
                nextPrestige += bonus;
                nextCount += 1;
                notify(`è»¢ç”Ÿå®Œäº†ï¼ ãƒœãƒ¼ãƒŠã‚¹ +${(bonus * 100).toFixed(1)}%`);
            } else {
                notify('åˆæœŸåŒ–ã—ã¾ã—ãŸ');
            }

            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå®šç¾©ã‹ã‚‰ã‚³ãƒ”ãƒ¼ï¼ˆé–¢æ•°ã‚’ä¿æŒï¼‰
            producers = defaultProducers.map(p => ({ ...p }));
            upgrades = defaultUpgrades.map(u => ({ ...u }));
            artifacts = defaultArtifacts.map(a => ({ ...a, bought: false }));
            // Achievements are NOT reset on reincarnation (usually) but here we follow simple logic:
            // If simple reset, wipe all. If reincarnation, maybe keep? 
            // For now, let's keep achievements on Reincarnation, wipe on Reset.
            if (!canReincarnate) {
                achievements = defaultAchievements.map(a => ({ ...a }));
            } else {
                // Keep achievements but re-bind functions just in case
                // Actually achievements state is in `achievements` array. 
                // We need to ensure `condition` and `reward` functions are preserved if we loaded from JSON?
                // No, we map from defaultAchievements on load. 
                // So here, we just keep the current `achievements` array as is.
            }

            gameState = {
                money: 0,
                totalZ: 0,
                clickPower: 1,
                globalMultiplier: 1,
                producerMultipliers: {},
                playTimeSec: 0, // Maybe keep playTime? Let's reset for "run time"
                reincarnationCount: nextCount,
                prestigeMultiplier: nextPrestige,
                lastTick: Date.now()
            };

            saveGame(); // Save immediately
            updateUI();
        }

        /* ----- ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œï¼šã‚¯ãƒªãƒƒã‚¯ã§Zã‚’ç²å¾— ----- */
        const tapEl = document.getElementById('tapGain');
        if (tapEl) {
            tapEl.addEventListener('click', () => {
                gameState.money += gameState.clickPower;
                gameState.totalZ += gameState.clickPower;
                // ã‚¯ãƒªãƒƒã‚¯ã§å®Ÿç¸¾ãŒå¤‰ã‚ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚ãƒã‚§ãƒƒã‚¯
                try { checkAchievements(); } catch (e) { console.error(e) }
                updateUI();
            });
        }

        /* ----- ã‚¿ãƒ–åˆ‡æ›¿å‡¦ç†ï¼ˆå³ã‚«ãƒ©ãƒ ï¼‰ ----- */
        let currentTab = 'mono';
        const tabButtons = document.querySelectorAll('.tab-btn');
        tabButtons.forEach(b => {
            b.addEventListener('click', () => {
                tabButtons.forEach(bb => bb.classList.remove('active'));
                b.classList.add('active');
                currentTab = b.dataset.tab;
                const content = document.getElementById('tabContent');
                content.innerHTML = '';
                if (currentTab === 'mono') {
                    const div = document.createElement('div'); div.id = 'monoPanel';
                    content.appendChild(div);
                    renderMonoPanel();
                } else if (currentTab === 'chie') {
                    renderChiePanel();
                } else if (currentTab === 'ach') {
                    renderAchPanel();
                }
            });
        });

        /* ----- ãƒœã‚¿ãƒ³ï¼ˆã‚»ãƒ¼ãƒ–ç­‰ï¼‰ã®æ¥ç¶š ----- */
        const saveBtn = document.getElementById('saveBtn');
        if (saveBtn) saveBtn.addEventListener('click', saveGame);
        const loadBtn = document.getElementById('loadBtn');
        if (loadBtn) loadBtn.addEventListener('click', () => loadGame(false));
        const resetBtn = document.getElementById('resetBtn');
        if (resetBtn) resetBtn.addEventListener('click', resetGame);

        /* ----- è‡ªå‹•ã‚»ãƒ¼ãƒ–ï¼ˆä¸€å®šé–“éš”ï¼‰ ----- */
        setInterval(() => { saveGame(); }, 60000);

        /* ----- ãƒ¡ã‚¤ãƒ³ãƒ«ãƒ¼ãƒ—ï¼ˆrequestAnimationFrameï¼‰ ----- */
        let lastTime = performance.now();
        let uiTimer = 0;
        function mainLoop(now) {
            const dtMs = now - lastTime;
            lastTime = now;
            const dt = dtMs / 1000;
            tick(dt);

            uiTimer += dt;
            if (uiTimer >= 1.0) {
                updateUI();
                uiTimer = 0;
            }

            requestAnimationFrame(mainLoop);
        }

        /* ----- CodePenãªã©ã§rAFãŒæ­¢ã¾ã£ãŸå ´åˆã®è£œå¡«ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰ ----- */
        /*
          rAF ãŒåœæ­¢ã—ã¦ã„ã‚‹ï¼ˆ/æ¥µç«¯ã«é–“å¼•ã‹ã‚Œã¦ã„ã‚‹ï¼‰ç’°å¢ƒã§ã¯ tick ãŒå‘¼ã°ã‚Œãšæ”¾ç½®åˆ†ãŒå¤±ã‚ã‚Œã‚‹ã€‚
          ãã“ã§ tick ãŒæ­¢ã¾ã£ã¦ã„ã‚‹æ™‚é–“ã‚’ _lastTickTime ã§åˆ¤å®šã—ã€setInterval ã§ã¾ã¨ã‚ã¦è£œå¡«ã™ã‚‹ã€‚
          - rAF ãŒå‹•ã„ã¦ã„ã‚‹å ´åˆï¼ˆtickãŒæ›´æ–°ã—ã¦ã„ã‚‹ã¨ãï¼‰ã¯ä½•ã‚‚ã—ãªã„ï¼ˆäºŒé‡åŠ ç®—ã‚’é˜²æ­¢ï¼‰ã€‚
        */
        setInterval(() => {
            const now = Date.now();
            const elapsed = (now - _lastTickTime) / 1000;
            // rAFãŒå‹•ã„ã¦ã„ã‚Œã° elapsed ã¯éå¸¸ã«å°ã•ã„ã®ã§ä½•ã‚‚ã—ãªã„
            if (elapsed < 0.5) return;

            // rAFãŒæ­¢ã¾ã£ã¦ã„ã‚‹æ™‚é–“ã ã‘ã¾ã¨ã‚ã¦åŠ ç®—
            const prod = calcProdPerSecond();
            const gain = prod * elapsed;
            if (gain > 0) {
                gameState.money += gain;
                gameState.totalZ += gain;
                gameState.playTimeSec += elapsed;
                try { checkAchievements(); } catch (e) { console.error(e) }
                try { updateUI(); } catch (e) { console.error(e) }
            }
            _lastTickTime = now;
        }, 1000);

        /* ----- åˆæœŸåŒ–å‡¦ç†ï¼ˆèµ·å‹•æ™‚ã«ä¸€åº¦ã ã‘å®Ÿè¡Œï¼‰ ----- */
        (function init() {
            // ã‚»ãƒ¼ãƒ–ãŒã‚ã‚Œã°èª­ã¿è¾¼ã‚€ï¼ˆèµ·å‹•æ™‚ã¯é€šçŸ¥ã‚’æ§ãˆã‚‹ï¼‰
            loadGame(true);

            // åˆå›UIæ›´æ–°
            updateUI();
            // ãƒ¡ã‚¤ãƒ³ãƒ«ãƒ¼ãƒ—é–‹å§‹
            requestAnimationFrame(mainLoop);
        })();

        /* ----- è£œåŠ©ï¼šãŠé‡‘ä¸è¶³ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ï¼ˆçŸ­æ™‚é–“ç‚¹æ»…ï¼‰ ----- */
        function flashInsufficient() {
            const el = document.getElementById('money');
            if (!el) return;
            el.style.transition = 'none';
            el.style.color = '#ffb4b4';
            setTimeout(() => { el.style.transition = 'color 400ms'; el.style.color = '#fff' }, 220);
        }
    </script>
</body>

</html>
